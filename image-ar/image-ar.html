<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Image Viewer – AR (MindAR + Editor Handshake)</title>

  <!-- Preconnects -->
  <link rel="preconnect" href="https://aframe.io" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>

  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{
      margin:0;height:100%;
      background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      overflow:hidden;overscroll-behavior:none;touch-action:manipulation;
      -webkit-user-select:none;user-select:none;
    }

    /* A-Frame UI ausblenden + Canvas transparent */
    .a-enter-vr,.a-enter-ar,.a-enter-vr-button,.a-modal{display:none!important}
    a-scene, canvas.a-canvas { background: transparent !important; }

    /* Ebenen: 0 Video (Preview/MindAR), 1 Canvas (A-Frame), 2 ScanUI/Hint, 3 Overlay, 4 Error */
    #videoLayer{position:fixed;inset:0;z-index:0;width:100vw;height:100svh;background:#000}
    #videoLayer video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center;display:block}
    #poster{position:absolute;inset:0;background:center/cover no-repeat url("/area/assets/targets/target.png?v=1")}

    /* UI-Layer der WebXR DOM-Overlay API, falls genutzt */
    #ui{position:fixed;inset:0;pointer-events:none;z-index:2}
    .btn{pointer-events:auto;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.25);background:#111;color:#fff}

    /* Scanner-UI */
    #scanUI{
      position:fixed;inset:0;z-index:2;pointer-events:none;display:none;
      padding:max(12px,env(safe-area-inset-top)) max(12px,env(safe-area-inset-right))
              max(12px,env(safe-area-inset-bottom)) max(12px,env(safe-area-inset-left));
    }
    #scanUI .frame{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      width:min(70vw, 480px);height:min(45vh, 360px);
    }
    #scanUI .corner{position:absolute;width:28px;height:28px;border:3px solid rgba(255,255,255,.9)}
    #scanUI .tl{left:-3px;top:-3px;border-right:none;border-bottom:none;border-top-left-radius:12px}
    #scanUI .tr{right:-3px;top:-3px;border-left:none;border-bottom:none;border-top-right-radius:12px}
    #scanUI .bl{left:-3px;bottom:-3px;border-right:none;border-top:none;border-bottom-left-radius:12px}
    #scanUI .br{right:-3px;bottom:-3px;border-left:none;border-top:none;border-bottom-right-radius:12px}
    #scanUI .msg{
      position:absolute;left:50%;top:calc(100% + 10px);transform:translateX(-50%);
      background:rgba(0,0,0,.55);padding:8px 10px;border-radius:10px;font-size:14px
    }

    /* Hint oben rechts */
    #hint{
      position:fixed;right:max(12px,env(safe-area-inset-right));top:max(12px,env(safe-area-inset-top));
      z-index:2;pointer-events:none;display:none
    }
    #hint img{width:min(28vw,180px);height:auto;border-radius:12px;opacity:.92;box-shadow:0 6px 18px rgba(0,0,0,.35)}

    /* Overlay (Startkarte) */
    #overlay{
      position:fixed;inset:0;z-index:3;display:grid;place-items:center;
      padding:max(16px,env(safe-area-inset-top)) max(16px,env(safe-area-inset-right))
              max(16px,env(safe-area-inset-bottom)) max(16px,env(safe-area-inset-left));
      background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,.35));
      transition:opacity .12s ease-out, visibility .12s ease-out;
    }
    #overlay.hidden{opacity:0;visibility:hidden}
    .card{
      width:min(92vw,520px);max-height:min(80svh,700px);
      display:flex;flex-direction:column;gap:12px;
      border-radius:16px;padding:16px;background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.15);box-shadow:0 10px 30px rgba(0,0,0,.35)
    }
    .card img{width:100%;max-height:44svh;object-fit:cover;border-radius:12px}
    .card h2{margin:4px 0 0;font-size:18px}
    .tips{margin:0;padding-left:18px;opacity:.9}
    .tips li{margin:2px 0}
    .card .btn{width:100%;padding:12px 14px}

    /* Error-Badge */
    #err{position:fixed;left:12px;top:12px;z-index:4;background:#b00020;padding:8px 10px;border-radius:8px;display:none;font:12px/1.35 monospace}

    /* Fallback für Browser ohne svh */
    @supports not (height:100svh){
      html,body,#videoLayer{height:calc(var(--vh,1vh)*100)}
    }
  </style>

  <!-- Libs -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
</head>
<body>
  <!-- Fehleranzeige -->
  <div id="err"></div>

  <!-- 0) Kamera-Preview (läuft sofort) -->
  <div id="videoLayer">
    <div id="poster"></div>
    <video id="preview" autoplay muted playsinline></video>
  </div>

  <!-- 1) Eigenes Scanner-UI + Hint -->
  <div id="scanUI">
    <div class="frame">
      <div class="corner tl"></div><div class="corner tr"></div>
      <div class="corner bl"></div><div class="corner br"></div>
      <div class="msg">Suche dieses Bild…</div>
    </div>
  </div>
  <div id="hint"><img id="hintImg" alt="Referenzbild"></div>

  <!-- 2) Overlay-Kachel -->
  <div id="overlay" role="dialog" aria-modal="true">
    <div class="card">
      <img id="overlayImg" alt="Szenenbild">
      <h2 id="overlayTitle">AR-Erlebnis starten</h2>
      <ul class="tips" id="overlayTips">
        <li>Achte auf deine Umgebung.</li>
        <li>Richte die Kamera auf das Bild.</li>
        <li>Gute Beleuchtung verbessert das Tracking.</li>
      </ul>
      <button id="startBtn" class="btn">OK – Scanner starten</button>
    </div>
  </div>

  <!-- Overlay-UI-Layer (für DOM-Overlay kompatibel) -->
  <div id="ui"></div>

  <script>
  // ---------- Hilfen ----------
  (function fixVH(){
    function setVH(){ document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px'); }
    setVH(); addEventListener('resize', setVH, {passive:true});
  })();
  const showErr = (m)=>{ const el=document.getElementById('err'); el.textContent=m; el.style.display='block'; };

  // ---------- Default-Konfig ----------
  let cfg = {
    meta:    { version:"1.0", mode:"image", title:null, tips:null },
    target:  { mindUrl:"/area/assets/targets/target.mind", previewUrl:"/area/assets/targets/target.png" },
    model:   { url:"https://modelviewer.dev/shared-assets/models/Astronaut.glb",
               position:[0,0,0], rotation:[0,0,0], scale:[0.6,0.6,0.6], animation:"*" },
    lighting:{ hemi:1.2, dir:{ intensity:1.0, pos:[0,6,0] } },
    audio:   { url:null, loop:true, volume:0.8, autoplayOnTarget:false }
  };

  // ---------- Szene aus ?scene= laden (optional) ----------
  const qs = new URLSearchParams(location.search);
  const sceneUrl = qs.get('scene');

  // ID + Worker → direkte GLB-URL bauen
const workerBase = (qs.get('base') || '').replace(/\/$/, '');
const sceneId    = qs.get('scene');
if (workerBase && sceneId && !/^https?:/i.test(sceneUrl||'')) {
  const GLB = `${workerBase}/scenes/${encodeURIComponent(sceneId)}/scene.glb`;
  cfg.model.url = GLB;       // sofort setzen; JSON bleibt optional
}


  async function maybeLoadSceneFromQuery(){
    if (!sceneUrl) return;
    try{
      const res = await fetch(sceneUrl, {cache:'no-cache'});
      if (!res.ok) throw new Error(res.status+' '+res.statusText);
      const j = await res.json();
      // Tiefenmerge (flach genug für unsere Struktur)
      cfg = {
        ...cfg,
        ...j,
        target:   {...cfg.target,   ...(j.target||{})},
        model:    {...cfg.model,    ...(j.model||{})},
        lighting: {
          ...cfg.lighting,
          ...(j.lighting||{}),
          dir: { ...(cfg.lighting.dir||{}), ...((j.lighting&&j.lighting.dir)||{}) }
        },
        audio:    {...cfg.audio,    ...(j.audio||{})}
      };
    }catch(e){ showErr('scene.json konnte nicht geladen werden: '+e.message); }
  }

  // ---------- UI-Bilder & Texte setzen ----------
  function applyOverlayFromCfg(){
    const prev = (cfg.target?.previewUrl || "/area/assets/targets/target.png");
    const bust = (prev.includes('?')?'&':'?')+'v=1';
    document.getElementById('hintImg').src    = prev + bust;
    document.getElementById('overlayImg').src = prev + bust;
    if (cfg.meta?.title) document.getElementById('overlayTitle').textContent = cfg.meta.title;
    if (Array.isArray(cfg.meta?.tips) && cfg.meta.tips.length){
      document.getElementById('overlayTips').innerHTML = cfg.meta.tips.map(t=>`<li>${t}</li>`).join('');
    }
  }

  // ---------- Sofort: leichte Kamera-Preview ----------
  const videoLayer = document.getElementById('videoLayer');
  const previewVideo = document.getElementById('preview');
  const poster       = document.getElementById('poster');

  async function startPreview(){
    try{
      const constraints = {
        video: {
          facingMode: { ideal: 'environment' },
          width:  { ideal: 1280, max: 1280 },
          height: { ideal: 720,  max: 720  },
          frameRate: { ideal: 24, max: 30 }
        },
        audio:false
      };
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      previewVideo.srcObject = stream;
      poster.style.display = 'none';
    }catch(e){
      console.warn('Preview-Start fehlgeschlagen:', e);
      // Poster bleibt sichtbar
    }
  }
  function stopPreview(){
    const s = previewVideo.srcObject;
    if (s && s.getTracks) s.getTracks().forEach(t=>t.stop());
    previewVideo.srcObject = null;
    previewVideo.style.display = 'none';
  }

  // MindAR-Video nachträglich in #videoLayer ziehen (nicht blockierend)
  function tryAttachMindarVideoNonBlocking(maxWaitMs=4000){
    const t0 = performance.now();
    (function poll(){
      const v = document.getElementById('mindar-image-video')
           || document.querySelector('video#mindar-image-video')
           || [...document.querySelectorAll('video')].find(el => /mindar/i.test(el.id));
      if (v){
        v.setAttribute('playsinline',''); v.muted = true; v.autoplay = true;
        if (v.parentNode !== videoLayer) videoLayer.appendChild(v);
        Object.assign(v.style,{position:'absolute',inset:'0',width:'100%',height:'100%',objectFit:'cover',objectPosition:'center',display:'block'});
        stopPreview(); // jetzt Preview beenden
        return;
      }
      if (performance.now() - t0 > maxWaitMs) return; // einfach weiter mit Preview
      requestAnimationFrame(poll);
    })();
  }

  // ---------- A-Frame + MindAR Szene dynamisch bauen ----------
  let aframeScene = null;
  function buildAndStartMindAR(glbBlobUrl=null){
    if (aframeScene){ return; }

    const scene = document.createElement('a-scene');
    aframeScene = scene;
    scene.setAttribute('embedded','');
    scene.setAttribute('renderer','alpha:true; antialias:false; precision:mediump; physicallyCorrectLights:false; sortObjects:true; colorManagement:true');
    scene.setAttribute('vr-mode-ui','enabled:false');
    scene.style.position='fixed'; scene.style.inset='0'; scene.style.zIndex='1';

    // Wir nutzen EIGENES Scan-UI → MindAR-UI aus
    scene.setAttribute('mindar-image', `imageTargetSrc: ${cfg.target.mindUrl}; uiScanning: false; uiLoading: false`);

    // Kamera
    const cam = document.createElement('a-camera');
    cam.setAttribute('look-controls','enabled:false');
    scene.appendChild(cam);

    // Licht
    const hemi = document.createElement('a-entity');
    hemi.setAttribute('light', `type:hemisphere; intensity:${cfg.lighting?.hemi ?? 1.2}`);
    scene.appendChild(hemi);

    // Marker
    const marker = document.createElement('a-entity');
    marker.setAttribute('mindar-image-target','targetIndex: 0');

    // Modell
    const model = document.createElement('a-gltf-model');
    const srcUrl = glbBlobUrl || cfg.model.url;
    model.setAttribute('src', srcUrl);
    if (cfg.model.position) model.setAttribute('position', cfg.model.position.join(' '));
    if (cfg.model.rotation) model.setAttribute('rotation', cfg.model.rotation.join(' '));
    if (cfg.model.scale)    model.setAttribute('scale',    cfg.model.scale.join(' '));
    if (cfg.model.animation && cfg.model.animation !== 'none'){
      model.setAttribute('animation-mixer', `clip:${cfg.model.animation}; loop:repeat`);
    }
    marker.appendChild(model);
    scene.appendChild(marker);
    document.body.appendChild(scene);

    // Scanner/Hint steuern
    const scanUI = document.getElementById('scanUI');
    const hint   = document.getElementById('hint');
    const showScanning = ()=>{ scanUI.style.display='block'; hint.style.display='block'; };
    const hideScanning = ()=>{ scanUI.style.display='none';  hint.style.display='none';  };
    marker.addEventListener('targetFound', hideScanning);
    marker.addEventListener('targetLost',  showScanning);

    // MindAR starten (nicht UI-blockierend)
    scene.addEventListener('loaded', async ()=>{
      const sys = scene.systems['mindar-image-system'];
      try { await sys.start(); }
      catch (e) { showErr('MindAR konnte nicht gestartet werden: ' + e.message); return; }
      tryAttachMindarVideoNonBlocking(4000);

      // Akku sparen
      document.addEventListener('visibilitychange', () => {
        try { document.hidden ? sys.stop() : sys.start(); } catch {}
      }, {passive:true});
    }, {once:true});
  }

  // Defensive: A-Frame VR Elemente sofort entfernen
  new MutationObserver(()=>document.querySelectorAll('.a-enter-vr,.a-enter-vr-button,.a-modal').forEach(el=>el.remove()))
    .observe(document.documentElement,{childList:true,subtree:true});

  // ---------- Overlay Flow ----------
  const overlay   = document.getElementById('overlay');
  const startBtn  = document.getElementById('startBtn');
  const scanUI    = document.getElementById('scanUI');
  const hint      = document.getElementById('hint');

  startBtn.addEventListener('click', ()=>{
    overlay.classList.add('hidden');    // 1) Overlay sofort aus
    scanUI.style.display = 'block';     // 2) Scan-UI + Hint sofort an
    hint.style.display   = 'block';
    buildAndStartMindAR();              // 3) MindAR im Hintergrund booten
  });

  // ---------- Editor-Handshake ----------
  const ALLOW_ORIGIN = location.origin; // Editor läuft i.d.R. auf derselben Domain

  // Beim Laden dem Editor signalisieren, dass wir bereit sind
  function notifyReady(){
    try{ window.opener && window.opener.postMessage({type:'webar-ready'}, ALLOW_ORIGIN); }catch{}
    try{ window.parent  && window.parent  !== window && window.parent.postMessage({type:'webar-ready'}, ALLOW_ORIGIN); }catch{}
  }

  // Editor → Viewer: Payload empfangen
  window.addEventListener('message', async (e)=>{
    if (e.origin !== ALLOW_ORIGIN) return;
    const d = e.data || {};
    if (d.type !== 'webar-load') return;
    if (d.mode && d.mode !== 'image') return; // nur Image-Viewer

    // 1) Target (Mind)
    if (d.target) cfg.target.mindUrl = d.target;

    // 2) Transform aus Editor (RAD → DEG)
    if (d.transform){
      const T = d.transform;
      // Position direkt
      cfg.model.position = [T.px||0, T.py||0, T.pz||0];
      // Rotation: rad → deg
      const toDeg = r => Math.round((r||0) * 180/Math.PI * 1000)/1000;
      cfg.model.rotation = [toDeg(T.rx), toDeg(T.ry), toDeg(T.rz)];
      // Scale
      cfg.model.scale = [T.sx||1, T.sy||1, T.sz||1];
    }

    // 3) GLB aus ArrayBuffer (Transferable) in Blob-URL verwandeln
    let blobUrl = null;
    if (d.glbBuffer && d.glbBuffer.byteLength){
      try{
        const glbBlob = new Blob([d.glbBuffer], {type:'model/gltf-binary'});
        blobUrl = URL.createObjectURL(glbBlob);
        cfg.model.url = blobUrl;
      }catch(err){ showErr('GLB-Buffer konnte nicht gelesen werden.'); }
    }

    // 4) UI: Overlay sofort aus; Scan-UI/hint direkt an; MindAR starten
    overlay.classList.add('hidden');
    scanUI.style.display = 'block';
    hint.style.display   = 'block';
    buildAndStartMindAR(blobUrl);
  });

  // ---------- Boot ----------
  (async ()=>{
    await maybeLoadSceneFromQuery();   // optional ?scene= laden
    applyOverlayFromCfg();             // UI füllen
    startPreview();                    // Kamera-Preview starten
    notifyReady();                     // dem Editor sagen: "ready"
  })();
  </script>
</body>
</html>
