<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ARea ‚Äì Scene Viewer</title>
<link rel="icon" href="data:,">
<style>
  :root{ --bg:#0e1116; --panel:#111828; --panel2:#192339; --text:#e9ecf5; --muted:#9fb3d9; --border:#24314a; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Inter,Roboto,Arial}
  #app{position:fixed;inset:0}
  canvas{display:block;width:100%;height:100%}
  /* Kamera-Preview nur f√ºrs Overlay; AR nutzt echten XR-Feed */
  #camPreview{position:fixed;inset:0;object-fit:cover;z-index:0;display:none}
  .overlay{position:fixed;inset:0;display:grid;place-items:center;padding:24px;background:linear-gradient(180deg, rgba(14,17,22,.9), rgba(14,17,22,.96));z-index:2}
  .card{width:min(880px,92vw);border:1px solid var(--border);border-radius:20px;overflow:hidden;background:linear-gradient(180deg,#0b1220,#0e1422);box-shadow:0 12px 40px rgba(0,0,0,.4);display:grid;grid-template-columns:320px 1fr}
  .poster{background:#0a1220;min-height:260px}
  .poster img{width:100%;height:100%;object-fit:cover;display:block}
  .body{padding:22px}
  .eyebrow{font-size:12px;letter-spacing:.18em;text-transform:uppercase;color:var(--muted)}
  h1{font-size:28px;margin:.35rem 0 .4rem;line-height:1.2}
  p{color:#cbd5e1;margin:.2rem 0 .8rem}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:.6rem}
  .btn{cursor:pointer;border:1px solid var(--border);background:linear-gradient(180deg,#1a2337,#162033);color:var(--text);padding:10px 14px;border-radius:12px;font-weight:700}
  .hud{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;display:flex;gap:10px;background:rgba(14,17,22,.6);border:1px solid var(--border);border-radius:999px;padding:8px;backdrop-filter: blur(6px);z-index:3}
  .hud button{all:unset;cursor:pointer;padding:8px 12px;border-radius:10px}
  .toast{position:fixed;top:12px;right:12px;background:#111828;border:1px solid #24314a;color:#dbe1f1;padding:8px 12px;border-radius:10px;font-size:13px;box-shadow:0 8px 24px rgba(0,0,0,.25);z-index:4}
  @media (max-width:860px){ .card{grid-template-columns:1fr} .poster{max-height:40vh} }
</style>
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>
</head>
<body>
<video id="camPreview" autoplay muted playsinline></video>
<div id="app"></div>

<!-- Willkommen -->
<div id="welcome" class="overlay" style="display:grid">
  <div class="card">
    <div class="poster"><img id="welcomePoster" alt="Poster"></div>
    <div class="body">
      <div class="eyebrow" id="welcomeEyebrow">ARea ‚Äì Szene</div>
      <h1 id="welcomeTitle">Willkommen</h1>
      <p id="welcomeDesc">Diese Szene enth√§lt Animation und ggf. Audio. Tippe auf OK, um AR zu starten.</p>
      <div class="row">
        <button id="welcomeStart" class="btn" onclick="window.__start && window.__start()">OK</button>
        <span class="muted" id="welcomeHint" style="color:#9fb3d9;font-size:13px">Autostart kann Klick erfordern (Autoplay-Policy)</span>
      </div>
    </div>
  </div>
</div>

<!-- HUD -->
<div id="hud" class="hud" style="display:none">
  <button id="btnPlay" title="Play/Pause">‚ñ∂Ô∏é/‚è∏</button>
  <button id="btnReplay" title="Neu starten">‚Üª</button>
  <button id="btnSound" title="Ton an/aus">üîä</button>
</div>

<div id="toasts" style="display:grid;gap:10px;position:fixed;top:12px;right:12px"></div>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { GLTFLoader }  from 'three/addons/loaders/GLTFLoader.js';
import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';

const $ = s => document.querySelector(s);
const app   = $('#app');
const toasts= $('#toasts');
const welcome = $('#welcome'),
      poster  = $('#welcomePoster'),
      wTitle  = $('#welcomeTitle'),
      wDesc   = $('#welcomeDesc'),
      wStart  = $('#welcomeStart'),
      wEyebrow= $('#welcomeEyebrow');
const hud = $('#hud'),
      btnPlay  = $('#btnPlay'),
      btnReplay= $('#btnReplay'),
      btnSound = $('#btnSound');
const camPreview = $('#camPreview');

function toast(m){ const d=document.createElement('div'); d.className='toast'; d.textContent=m; toasts.appendChild(d); setTimeout(()=>d.remove(),2600); }
const show = (el, on)=>{ el && (el.style.display = on ? '' : 'none'); };

// ‚îÄ‚îÄ Query / Config URL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const qs = new URLSearchParams(location.search);
const workerBase = (qs.get('base') || 'https://area-publish.area-webar.workers.dev').replace(/\/$/,'');
const sceneId = (qs.get('scene') || qs.get('id') || '').trim();
const src = (qs.get('src') || '').trim();
const configURL = src || (sceneId ? `${workerBase}/scenes/${encodeURIComponent(sceneId)}/scene.json` : '');
if (!configURL){ toast('Keine scene.json ‚Äì ?scene=ID oder ?src=URL verwenden.'); }

// ‚îÄ‚îÄ THREE Setup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const renderer = new THREE.WebGLRenderer({ antialias:true, powerPreference:'high-performance', alpha:true });
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.setClearColor(0x000000, 0); // transparenter Hintergrund f√ºr XR-Kamera
renderer.setSize(innerWidth, innerHeight);
app.appendChild(renderer.domElement);

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(50, innerWidth/innerHeight, 0.01, 100); camera.position.set(2.5,1.6,3.6);
const controls = new OrbitControls(camera, renderer.domElement); controls.enableDamping=true; controls.target.set(0,1,0);

const hemi = new THREE.HemisphereLight(0xffffff, 0x334455, 0.9); scene.add(hemi);
const dir  = new THREE.DirectionalLight(0xffffff, 1.2); dir.position.set(4,6,3); scene.add(dir);

// AR-Reticle
let reticle=null;
function makeReticle(){
  const geo = new THREE.RingGeometry(0.07, 0.08, 32).rotateX(-Math.PI/2);
  const mat = new THREE.MeshBasicMaterial({ color:0x66ccff });
  const m = new THREE.Mesh(geo, mat); m.matrixAutoUpdate=false; m.visible=false;
  return m;
}

// Audio
const listener = new THREE.AudioListener(); camera.add(listener);
const audio = new THREE.Audio(listener);
const audioLoader = new THREE.AudioLoader();

// Animation/State
const clock = new THREE.Clock();
let mixer=null, clip=null, action=null, playing=false, playCount=0;
let cfg = null, gltf=null, root=null;
let audioReady = false;
let muted = false;
let baseVolume = 0.85;

let startClicked = false;
let wantStartAnim = false;
let deferredClick = false;

// WebXR AR state
let xrSession = null, hitTestSource = null, hitTestRequested = false, placed = false;
let pendingPlacementMatrix = null;

// ‚îÄ‚îÄ Utils / Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function deepMerge(a,b){ for(const k in b){ if(b[k] && typeof b[k]==='object' && !Array.isArray(b[k])) a[k]=deepMerge(a[k]||{},b[k]); else a[k]=b[k]; } return a; }
const DEFAULTS = {
  meta:{ autoplace:true },
  ui:{
    showGround:false, autocenter:true,
    welcome:{ eyebrow:'ARea ‚Äì Szene', title:'Willkommen', desc:'Tippe auf OK, um AR zu starten.', cta:'OK', poster:'' },
    controls:{ showPlay:true, showMute:true },
    overlayBackground:'poster' // 'poster' | 'camera'
  },
  camera:{ fov:50, near:.01, far:100, start:[2.5,1.6,3.6], lookAt:[0,1,0] },
  model:{ url:'', scale:1, rotateY:0 },
  animation:{ enabled:true, clipName:null, start:'onStart', loop:false, iterations:1, clampWhenFinished:true, crossfade:.25, timeScale:1 },
  audio:{ url:'', autoplay:'withAnimation', loop:true, volume:.85 }
};
function resolveRel(u, baseUrl){ if(!u) return u; try{ return new URL(u, baseUrl).href; }catch{ return u; } }

function updateHUD(){
  const showPlay = !!cfg?.ui?.controls?.showPlay && !!action;
  const showMute = !!cfg?.ui?.controls?.showMute && !!cfg?.audio?.url;
  btnPlay.style.display   = showPlay ? '' : 'none';
  btnReplay.style.display = showPlay ? '' : 'none';
  btnSound.style.display  = showMute ? '' : 'none';
  show(hud, (showPlay || showMute));
}

// ‚îÄ‚îÄ Config laden & anwenden ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(async()=>{
  try{
    const r = await fetch(configURL, { mode:'cors', cache:'no-cache' });
    const j = await r.json();
    cfg = deepMerge(structuredClone(DEFAULTS), j);

    // URLs aufl√∂sen
    if (cfg.model?.url)  cfg.model.url  = resolveRel(cfg.model.url,  configURL);
    if (!cfg.audio?.url && j?.audio?.src) cfg.audio.url = resolveRel(j.audio.src, configURL);
    if (cfg.audio?.url)  cfg.audio.url  = resolveRel(cfg.audio.url,  configURL);

    // Poster sammeln: ui.welcome.poster ‚Üí target.previewUrl ‚Üí poster.jpg
    let posterUrl = cfg.ui?.welcome?.poster || j?.target?.previewUrl || j?.poster;
    if (posterUrl) posterUrl = resolveRel(posterUrl, configURL);
    else if (sceneId) posterUrl = `${workerBase}/scenes/${encodeURIComponent(sceneId)}/poster.jpg`;

    // Welcome bef√ºllen
    document.title = (cfg.ui?.welcome?.title || 'ARea ‚Äì Scene Viewer');
    wEyebrow.textContent = cfg.ui?.welcome?.eyebrow ?? DEFAULTS.ui.welcome.eyebrow;
    wTitle.textContent   = cfg.ui?.welcome?.title   ?? DEFAULTS.ui.welcome.title;
    wDesc.textContent    = cfg.ui?.welcome?.desc    ?? DEFAULTS.ui.welcome.desc;
    wStart.textContent   = (cfg.ui?.welcome?.cta || 'OK');
    if (posterUrl) {
      poster.src = posterUrl;
      poster.onerror = () => { document.querySelector('.poster').style.display='none'; };
    } else {
      document.querySelector('.poster').style.display='none';
    }

  }catch(e){
    toast('Config konnte nicht geladen ‚Äì Defaults genutzt.');
    cfg = structuredClone(DEFAULTS);
  }

  // Kamera/Controls/Scene (Fallback-Viewer Setup; AR √ºberschreibt Hintergrund)
  camera.fov = cfg.camera.fov ?? camera.fov;
  camera.near= cfg.camera.near ?? camera.near;
  camera.far = cfg.camera.far ?? camera.far;
  camera.updateProjectionMatrix();
  if (cfg.camera.start) camera.position.set(...cfg.camera.start);
  if (cfg.camera.lookAt) controls.target.set(...cfg.camera.lookAt);

  baseVolume = cfg.audio?.volume ?? 0.85;

  // GLB laden (mit Draco)
  const loader = new GLTFLoader(); loader.setCrossOrigin('anonymous');
  const draco  = new DRACOLoader(); draco.setDecoderPath('https://www.gstatic.com/draco/v1/decoders/'); loader.setDRACOLoader(draco);
  try { gltf = await loader.loadAsync(cfg.model.url); }
  catch(e) { toast('GLB laden fehlgeschlagen'); console.warn(e); }

  root = gltf?.scene || new THREE.Group();
  root.traverse(o=>{ if(o.isMesh){ if(o.material?.map) o.material.map.colorSpace = THREE.SRGBColorSpace; }});
  root.scale.setScalar(cfg.model.scale||1);
  root.rotation.y = cfg.model.rotateY||0;
  scene.add(root);

  // Auto-Center (f√ºr Fallback; in AR wird positioniert)
  if (cfg.ui?.autocenter && root){
    const box = new THREE.Box3().setFromObject(root);
    const size = new THREE.Vector3(); box.getSize(size);
    const center = new THREE.Vector3(); box.getCenter(center);
    root.position.x += -center.x; root.position.z += -center.z; root.position.y += -box.min.y;
    const radius = Math.max(size.x,size.y,size.z)*0.6; const idealZ = radius/Math.tan((camera.fov*Math.PI/180)/2);
    camera.position.set(idealZ*0.8, radius*0.8, idealZ*1.1); controls.target.set(0, size.y*0.5, 0);
  }

  // Animation
  if (gltf?.animations?.length && cfg.animation.enabled){
    console.debug('GLTF animations:', gltf.animations.map(a=>a.name));
    mixer = new THREE.AnimationMixer(root);
    clip = cfg.animation.clipName
      ? THREE.AnimationClip.findByName(gltf.animations, cfg.animation.clipName) || gltf.animations[0]
      : gltf.animations[0];
    action = mixer.clipAction(clip);
    action.clampWhenFinished = !!cfg.animation.clampWhenFinished;
    action.timeScale = cfg.animation.timeScale ?? 1;
    if (cfg.animation.loop){ action.setLoop(THREE.LoopRepeat, Infinity); }
    else { action.setLoop(THREE.LoopOnce, 0); }
    mixer.addEventListener('finished', ()=>{
      if(cfg.animation.loop) return;
      if(cfg.animation.iterations && Number.isFinite(cfg.animation.iterations)){
        playCount++;
        if (playCount < cfg.animation.iterations){ action.reset(); action.play(); }
        else { playing=false; }
      }
    });
  } else {
    // keine Clips ‚Üí Play-Buttons verbergen
    cfg.ui.controls.showPlay = false;
  }

  // Audio
  if (cfg.audio?.url){
    try{
      await new Promise((resolve,reject)=>
        audioLoader.load(cfg.audio.url, (buf)=>{ audio.setBuffer(buf); audio.setLoop(!!cfg.audio.loop); audio.setVolume(baseVolume); audioReady=true; resolve(); }, undefined, reject)
      );
    }catch(e){ console.warn('Audio load fail', e); }
  }

  // Falls Benutzer schon auf OK tippte bevor Assets fertig waren
  if (startClicked){
    updateHUD();
    if (cfg?.animation?.start === 'onStart' && action) playAnim(true);
    if (cfg?.audio?.autoplay === 'auto') playSound();
  }
})();

// ‚îÄ‚îÄ AR Start / Hit-Test / Placement ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function canStartAR(){
  try { return !!(navigator.xr && await navigator.xr.isSessionSupported('immersive-ar')); }
  catch { return false; }
}

async function startAR(){
  const supported = await canStartAR();
  if (!supported) return false;

  xrSession = await navigator.xr.requestSession('immersive-ar', {
    requiredFeatures:['hit-test','local-floor'],
    optionalFeatures:['dom-overlay'],
    domOverlay:{ root: document.body }
  });

  renderer.xr.enabled = true;
  renderer.xr.setReferenceSpaceType('local-floor');
  await renderer.xr.setSession(xrSession);

  if (!reticle){ reticle = makeReticle(); scene.add(reticle); }
  hitTestRequested = false; placed = false; pendingPlacementMatrix = null;

  // Tap-Place (falls Autoplace deaktiviert)
  const controller = renderer.xr.getController(0);
  controller.addEventListener('select', ()=>{
    if (reticle && reticle.visible && !placed) placeModelFromMatrix(reticle.matrix);
  });
  scene.add(controller);

  xrSession.addEventListener('end', ()=>{
    hitTestSource = null; hitTestRequested = false; xrSession = null;
  });

  return true;
}

function placeModelFromMatrix(mat4){
  if (!root){ pendingPlacementMatrix = mat4.clone(); return; }
  root.matrixAutoUpdate = true;
  root.position.setFromMatrixPosition(mat4);
  placed = true;

  if (cfg?.animation?.start === 'onStart'){
    if (action) playAnim(true); else wantStartAnim = true;
  }
  if (cfg?.audio?.autoplay === 'auto') playSound();
}

// ‚îÄ‚îÄ Public Start (OK-Button) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.__start = async function(){
  startClicked = true;
  try { listener?.context?.resume?.(); } catch {}

  updateHUD();
  show(welcome,false);

  if (cfg?.ui?.overlayBackground === 'camera'){
    // optional: Preview hinter Overlay laufen lassen
    startCameraPreview();
  }

  const arStarted = await startAR().catch(()=>false);
  if (!arStarted){
    toast('WebXR-AR nicht verf√ºgbar ‚Äì zeige 3D ohne AR.');
    // Fallback: Non-AR, ggf. Animation/Audio starten
    if (cfg?.animation?.start === 'onStart' && action) playAnim(true);
    if (cfg?.audio?.autoplay === 'auto') playSound();
  }
};

// Overlay-Kamera (Preview, kein AR)
welcome.addEventListener('pointerdown', (e)=>{
  if (e.target !== wStart && cfg?.ui?.overlayBackground === 'camera') startCameraPreview();
});
function startCameraPreview(){
  if (camPreview.dataset.on === '1') return;
  navigator.mediaDevices?.getUserMedia?.({ video:{ facingMode:'environment' }, audio:false })
    .then(s=>{ camPreview.srcObject = s; camPreview.dataset.on='1'; show(camPreview, true); })
    .catch(()=>{});
}

// ‚îÄ‚îÄ Controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function playAnim(reset=false){
  if (!action) return;
  if (reset){ action.reset(); playCount=0; }
  action.enabled = true;
  action.fadeIn(cfg.animation?.crossfade || 0).play();
  action.paused = false;
  playing = true;
  if (cfg.audio?.autoplay === 'withAnimation' && audioReady && !audio.isPlaying) audio.play();
}
function pauseAnim(){
  if (!action) return;
  action.paused = true; playing = false;
  if (cfg.audio?.autoplay === 'withAnimation' && audioReady && audio.isPlaying) audio.stop();
}
function setMuted(on){
  muted = !!on;
  if (audioReady) audio.setVolume(muted ? 0 : baseVolume);
  btnSound.textContent = muted ? 'üîà' : 'üîä';
}
function toggleSound(){ if (!audioReady) return; setMuted(!muted); }
function playSound(){
  if (!audioReady) return;
  listener.context.resume?.();
  setMuted(false);
  if (!audio.isPlaying) audio.play();
}
btnPlay.addEventListener('click', ()=>{ if (!action) return; playing ? pauseAnim() : playAnim(); });
btnReplay.addEventListener('click', ()=>{ if (!action) return; playAnim(true); });
btnSound.addEventListener('click', toggleSound);

// ‚îÄ‚îÄ Render / XR-HitTest Loop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
renderer.setAnimationLoop((t, frame)=>{
  const dt = clock.getDelta();
  mixer?.update(dt);

  if (renderer.xr.isPresenting && frame){
    const refSpace = renderer.xr.getReferenceSpace();
    const session  = renderer.xr.getSession();

    if (!hitTestRequested){
      session.requestReferenceSpace('viewer').then((viewerSpace)=>{
        session.requestHitTestSource({ space: viewerSpace }).then(src => { hitTestSource = src; });
      });
      session.addEventListener('end', ()=>{ hitTestRequested=false; hitTestSource=null; });
      hitTestRequested = true;
    }

    if (hitTestSource){
      const hits = frame.getHitTestResults(hitTestSource);
      if (hits.length){
        const pose = hits[0].getPose(refSpace);
        if (!reticle){ reticle = makeReticle(); scene.add(reticle); }
        reticle.visible = true;
        reticle.matrix.fromArray(pose.transform.matrix);

        if (!placed && (cfg?.meta?.autoplace ?? true)){
          placeModelFromMatrix(new THREE.Matrix4().fromArray(pose.transform.matrix));
        }
      } else if (reticle){ reticle.visible = false; }
    }
  } else {
    controls.update();
  }

  if (pendingPlacementMatrix && root){
    placeModelFromMatrix(pendingPlacementMatrix);
    pendingPlacementMatrix = null;
  }

  renderer.render(scene, camera);
});

addEventListener('resize', ()=>{
  camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth, innerHeight);
});

// Tastatur-Guard (nur Konsistenz)
addEventListener('keydown', (e)=>{
  if ((e.key||'').toLowerCase() !== 't') return;
  const el = e.target;
  if (el && el.closest && el.closest('input,textarea,select,[contenteditable="true"]')) e.stopPropagation();
});
</script>
</body>
</html>
