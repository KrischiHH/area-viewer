<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ARea – AR Viewer</title>
  <meta name="theme-color" content="#0b1323" />
  <style>
    :root{ --bg:#0b1323; --panel:#0f1626; --text:#e9eefb; --muted:#a7b4d6; --border:#1f2940; --accent:#7aa2ff; --accent2:#5eead4; --danger:#ef4444; }
    *{ box-sizing:border-box }
    html,body{ margin:0; height:100%; background:#000; color:var(--text); font:14px/1.45 system-ui,Segoe UI,Inter,Roboto,Arial,sans-serif }
    canvas{ display:block }

    #overlay{ position:fixed; inset:0; display:grid; place-items:center; z-index:10; pointer-events:auto }
    .card{
      width:min(720px,92vw);
      border:1px solid var(--border); border-radius:16px; overflow:hidden;
      background:color-mix(in srgb, var(--panel) 86%, transparent);
      box-shadow:0 18px 48px rgba(0,0,0,.5);
      backdrop-filter:saturate(1.1) blur(8px);
    }
    .poster{ width:100%; display:block; background:#000; object-fit:cover; aspect-ratio:16/9 }
    .pbody{ padding:14px 14px 16px }
    .eyebrow{ font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.12em }
    .title{ font-weight:800; font-size:18px; margin:4px 0 }
    .desc{ color:var(--muted) }
    .prow{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px }
    .btn{ background:var(--panel); border:1px solid var(--border); color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:800 }
    .btn:hover{ border-color:var(--accent) }
    .btn.primary{ background:linear-gradient(180deg, color-mix(in srgb, var(--panel) 78%, var(--accent) 22%), color-mix(in srgb, var(--panel) 85%, var(--accent2) 15%)); }

    #hud{ position:fixed; left:0; right:0; bottom:env(safe-area-inset-bottom); padding:10px; display:flex; justify-content:center; pointer-events:auto; z-index:9 }
    #hud .bar{ display:flex; gap:8px; padding:8px; border:1px solid var(--border); border-radius:999px; background:color-mix(in srgb, var(--panel) 86%, transparent); box-shadow:0 10px 24px rgba(0,0,0,.35) }
    .iconbtn{ display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:999px; border:1px solid var(--border); background:color-mix(in srgb, var(--panel) 92%, transparent); color:var(--text); cursor:pointer; font-weight:800 }
    .iconbtn:hover{ border-color:var(--accent) }
    .iconbtn.danger{ border-color:#6b1a1a; color:#ffdede }
    .iconbtn[hidden]{ display:none }

    #status{ position:fixed; top:12px; left:12px; right:12px; pointer-events:none; background:color-mix(in srgb, var(--panel) 85%, transparent); border:1px solid var(--border); color:var(--muted); border-radius:10px; padding:8px 10px; display:inline-block; max-width:calc(100vw - 24px); }
    .pulse{ animation:pulse 1.1s ease-in-out infinite }
    @keyframes pulse{ 0%{opacity:.6} 50%{opacity:1} 100%{opacity:.6} }

    [hidden]{ display:none !important }
  </style>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>
<body>
  <div id="overlay">
    <div class="card">
      <img id="poster" class="poster" alt="">
      <div class="pbody">
        <div id="eyebrow" class="eyebrow">ARea – Szene</div>
        <div id="title" class="title">Titel der Szene</div>
        <div id="desc" class="desc">Klicke auf Start. Scanne eine ebene Fläche und tippe zum Platzieren. Danach starten Animation und Audio automatisch.</div>
        <div class="prow">
          <button id="btn-start" class="btn primary">Start AR</button>
        </div>
      </div>
    </div>
  </div>

  <div id="hud" hidden>
    <div class="bar">
      <button id="btn-replace" class="iconbtn">Neu ausrichten</button>
      <button id="btn-mute" class="iconbtn" hidden>Mute</button>
    </div>
  </div>

  <div id="status">Lade Szene…</div>

  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';

    const $ = s => document.querySelector(s);
    const setStatus = (t,pulse=false)=>{ const e=$('#status'); e.textContent=t; e.classList.toggle('pulse', !!pulse); };

    function qs(key){ return new URL(location.href).searchParams.get(key); }
    function resolveUrl(rel, cfg){
      if (!rel) return '';
      if (/^https?:|^data:|^blob:/.test(rel)) return rel;
      const b=(cfg.__base||'').replace(/\/$/,''); return b ? (b + '/' + rel.replace(/^\//,'')) : rel;
    }

    async function loadConfig(){
      // src=… (data:, http(s), inline-JSON) ODER scene=<id>&base=<root>
      const src = qs('src');
      if (src){
        const isData = src.startsWith('data:');
        if (isData){
          const afterComma = src.split(',')[1]||'';
          if (src.includes(';base64,')){
            const bin = atob(afterComma);
            const bytes = Uint8Array.from(bin, c=>c.charCodeAt(0));
            const text = new TextDecoder('utf-8').decode(bytes);
            return JSON.parse(text);
          } else {
            return JSON.parse(decodeURIComponent(afterComma));
          }
        } else if (/^https?:\/\//.test(src)){
          const res = await fetch(src, { cache:'no-store' }); if (!res.ok) throw new Error('src-URL nicht erreichbar');
          const json = await res.json();
          try{
            const u = new URL(src, location.href);
            if (u.pathname.endsWith('/scene.json')) json.__base = u.origin + u.pathname.replace(/\/scene\.json$/,'');
          }catch{}
          return json;
        } else {
          return JSON.parse(decodeURIComponent(src));
        }
      }
      const id = qs('scene') || qs('id');
      const base = qs('base') || 'https://area-publish.area-webar.workers.dev';
      if (!id) throw new Error('Kein scene oder src angegeben');
      const root = base.replace(/\/$/,'') + '/scenes/' + encodeURIComponent(id);
      const url = `${root}/scene.json`;
      const res = await fetch(url, { cache:'no-store' }); if (!res.ok) throw new Error('scene.json nicht gefunden');
      const json = await res.json(); json.__base = root; return json;
    }

    // THREE setup
    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true, powerPreference:'high-performance' });
    renderer.setPixelRatio(Math.min(devicePixelRatio||1, 2));
    renderer.setSize(innerWidth, innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.1;
    document.body.prepend(renderer.domElement);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, innerWidth/innerHeight, 0.01, 50);
    const hemi = new THREE.HemisphereLight(0xffffff, 0x334466, 1.2); scene.add(hemi);
    const dir  = new THREE.DirectionalLight(0xffffff, 1.6); dir.position.set(0,3,1); scene.add(dir);

    window.addEventListener('resize', ()=>{
      renderer.setSize(innerWidth, innerHeight);
      camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix();
    });

    // Reticle (Ring) für Hit-Test
    const reticle = new THREE.Mesh(
      new THREE.RingGeometry(0.09, 0.1, 32).rotateX(-Math.PI/2),
      new THREE.MeshBasicMaterial({ color:0x88ccff, transparent:true, opacity:0.85 })
    );
    reticle.matrixAutoUpdate = false; reticle.visible = false; scene.add(reticle);

    // Loader
    const gltfLoader = new GLTFLoader();
    const draco = new DRACOLoader(); draco.setDecoderPath('https://www.gstatic.com/draco/v1/decoders/');
    gltfLoader.setDRACOLoader(draco);

    // State
    let cfgCache=null;
    let model=null;        // THREE.Group (Root)
    let mixer=null;        // THREE.AnimationMixer
    let audio=null;        // THREE.Audio
    let placed=false;
    let startedClip=false;
    let xrSession=null, refSpace=null, viewerSpace=null, hitTestSource=null;

    function pickClip(gltf, cfg){
      const clips = gltf.animations || [];
      if (!clips.length) return null;
      const want = cfg?.animation?.clipName;
      if (want === 'none' || want === null) return null;
      if (!want || want === '*') return clips[0];
      return clips.find(c=>c.name===want) || clips[0];
    }

    function startAnimationAndAudio(cfg){
      if (mixer && model && model.userData._clip){
        const clip = model.userData._clip;
        const act = mixer.clipAction(clip);
        const loop = cfg?.animation?.loop !== false;
        act.setLoop(loop ? THREE.LoopRepeat : THREE.LoopOnce, loop ? (cfg?.animation?.iterations||9999) : 0);
        act.clampWhenFinished = true;
        act.reset().play();
        mixer.timeScale = 1;
      }
      if (audio && audio.buffer && !audio.isPlaying){
        try{ audio.play(); }catch{}
      }
    }
    function stopAnimationAndAudio(){
      if (mixer) mixer.timeScale = 0;
      if (audio?.isPlaying){ (audio.pause||audio.stop).call(audio); }
    }

    async function loadModel(cfg){
      const url = resolveUrl(cfg.model?.url || 'scene.glb', cfg);
      const gltf = await gltfLoader.loadAsync(url);
      const root = gltf.scene || gltf.scenes?.[0];
      root.updateMatrixWorld(true);

      model = new THREE.Group();
      model.name='ModelRoot';
      model.add(root);
      scene.add(model);

      // Basis-Scale
      const s = cfg.model?.scale || 1;
      model.scale.setScalar(s);

      // Animation
      if (gltf.animations?.length){
        mixer = new THREE.AnimationMixer(root);
        model.userData._clip = pickClip(gltf, cfg);
      }

      // Audio
      if (cfg.audio?.url){
        const listener = new THREE.AudioListener(); camera.add(listener);
        const snd = new THREE.Audio(listener);
        const res = await fetch(resolveUrl(cfg.audio.url, cfg)); const buf = await res.arrayBuffer();
        const ab = await listener.context.decodeAudioData(buf);
        snd.setBuffer(ab);
        snd.setLoop(!!cfg.audio.loop || cfg.audio.loop == null); // default: loop an
        snd.setVolume(Number.isFinite(cfg.audio.volume) ? cfg.audio.volume : 0.85);
        audio = snd; model.add(snd);
        $('#btn-mute').hidden = false;
      } else {
        $('#btn-mute').hidden = true;
      }
    }

    async function startXR(cfg){
      if (!navigator.xr) throw new Error('WebXR wird nicht unterstützt');
      const supported = await navigator.xr.isSessionSupported('immersive-ar');
      if (!supported) throw new Error('AR-Session wird auf diesem Gerät/Browser nicht unterstützt');

      const sessionInit = { requiredFeatures:['hit-test'], optionalFeatures:['dom-overlay'], domOverlay:{ root: document.body } };
      xrSession = await navigator.xr.requestSession('immersive-ar', sessionInit);

      renderer.xr.enabled = true;
      await renderer.xr.setSession(xrSession);
      refSpace = await xrSession.requestReferenceSpace('local');
      viewerSpace = await xrSession.requestReferenceSpace('viewer');
      hitTestSource = await xrSession.requestHitTestSource({ space: viewerSpace });

      xrSession.addEventListener('end', ()=>{
        setStatus('Session beendet');
        $('#hud').hidden = true;
        placed = false;
        stopAnimationAndAudio();
      });

      // Platzieren via Tap
      xrSession.addEventListener('select', ()=>{
        if (!reticle.visible || !model) return;
        // Reticle-Matrix -> Model
        model.matrix.copy(reticle.matrix);
        model.matrix.decompose(model.position, model.quaternion, model.scale);
        placed = true;
        setStatus('Platziert – Animation/Audio laufen');
        // Autostart
        if (!startedClip){ startAnimationAndAudio(cfg); startedClip = true; }
        $('#hud').hidden = false;
      });

      // Renderloop
      renderer.setAnimationLoop((t, frame)=>{
        if (!frame) return;
        const ht = frame.getHitTestResults(hitTestSource);
        if (ht.length){
          const pose = ht[0].getPose(refSpace);
          if (pose?.transform?.matrix){
            reticle.visible = true;
            reticle.matrix.fromArray(pose.transform.matrix);
          }
          if (!document.body.__pfGone){ hidePreflight(); setStatus('Tippe, um zu platzieren'); }
        } else {
          reticle.visible = false;
        }
        const dt = renderer.xr.getClock().getDelta();
        if (mixer) mixer.update(dt);
        renderer.render(scene, camera);
      });

      setStatus('Scanne Umgebung…', true);
    }

    function hidePreflight(){
      const ov = $('#overlay');
      if (!ov || document.body.__pfGone) return;
      ov.style.transition='opacity .3s ease';
      ov.style.opacity='0';
      setTimeout(()=>{ ov.hidden = true; document.body.__pfGone = true; }, 320);
    }

    // UI
    $('#btn-start').onclick = async ()=>{
      try{
        if (!cfgCache){
          cfgCache = await loadConfig();
          // UI-Texte/Poster
          $('#eyebrow').textContent = cfgCache.ui?.welcome?.eyebrow || 'ARea – Szene';
          $('#title').textContent   = cfgCache.ui?.welcome?.title   || cfgCache.meta?.title || 'Scene';
          $('#desc').textContent    = cfgCache.ui?.welcome?.desc    || 'Erlaube Kamera & bewege das Gerät zum Erkennen der Oberfläche.';
          const posterUrl = resolveUrl(cfgCache.ui?.welcome?.poster || 'poster.jpg', cfgCache);
          $('#poster').src = posterUrl;
        }
        await loadModel(cfgCache);
        await startXR(cfgCache);
      }catch(e){
        console.error(e);
        alert('Konnte AR nicht starten: ' + (e?.message||String(e)));
      }
    };

    $('#btn-replace').onclick = ()=>{
      placed = false;
      startedClip = false;
      setStatus('Tippe, um neu zu platzieren');
      stopAnimationAndAudio();
    };

    let muted=false;
    $('#btn-mute').onclick = ()=>{
      if (!audio) return;
      muted = !muted;
      audio.setVolume(muted ? 0 : (Number.isFinite(cfgCache?.audio?.volume)?cfgCache.audio.volume:0.85));
      $('#btn-mute').classList.toggle('danger', muted);
    };

    // Start
    (async function(){
      try{
        setStatus('Lade Szene…');
        cfgCache = await loadConfig();
        $('#eyebrow').textContent = cfgCache.ui?.welcome?.eyebrow || 'ARea – Szene';
        $('#title').textContent   = cfgCache.ui?.welcome?.title   || cfgCache.meta?.title || 'Scene';
        $('#desc').textContent    = cfgCache.ui?.welcome?.desc    || 'Erlaube Kamera & bewege das Gerät zum Erkennen der Oberfläche.';
        const posterUrl = resolveUrl(cfgCache.ui?.welcome?.poster || 'poster.jpg', cfgCache);
        $('#poster').src = posterUrl;
        setStatus('Bereit – Start AR');
      }catch(e){
        console.error(e);
        alert('Initialisierungsfehler: ' + (e?.message||String(e)));
      }
    })();
  </script>
</body>
</html>
