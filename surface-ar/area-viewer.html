<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ARea Viewer – Surface AR</title>

  <!-- model-viewer -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <style>
    :root{color-scheme:dark light}
    *,*::before,*::after{box-sizing:border-box}
    html,body{
      margin:0;
      height:100%;
      background:#000;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }

    /* Vollbild-Poster */
    #poster{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#05070c;
      z-index:5;
      color:#fff;
      text-align:center;
      padding:24px;
    }
    #poster-inner{
      max-width:420px;
      width:100%;
      padding:24px 20px;
      border-radius:24px;
      background:radial-gradient(circle at top,#243b74,#05070c);
      box-shadow:0 18px 40px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.15);
    }
    #poster h1{
      font-size:22px;
      margin:0 0 8px;
    }
    #poster p{
      margin:0 0 16px;
      font-size:14px;
      opacity:0.9;
    }
    #startAr{
      appearance:none;
      border:none;
      border-radius:999px;
      padding:10px 20px;
      font-size:15px;
      font-weight:500;
      background:linear-gradient(135deg,#5ddcff,#3c67e3);
      color:#fff;
      cursor:pointer;
      box-shadow:0 10px 25px rgba(0,0,0,0.5);
    }
    #startAr[disabled]{
      opacity:0.6;
      cursor:wait;
    }

    /* model-viewer selbst bleibt unsichtbar im Hintergrund */
    model-viewer{
      position:fixed;
      inset:0;
      width:100vw;
      height:100svh;
      display:block;
      background:#000;
      visibility:hidden; /* kein Preview sichtbar */
    }

    #err{
      position:fixed;
      left:12px;
      top:12px;
      z-index:9;
      background:#b00020;
      color:#fff;
      padding:8px 10px;
      border-radius:8px;
      display:none;
      font:12px/1.35 monospace;
      max-width:min(92vw,680px);
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <div id="err"></div>

  <!-- Willkommen-Poster statt 3D-Preview -->
  <div id="poster">
    <div id="poster-inner">
      <h1 id="posterTitle">ARea AR-Erlebnis</h1>
      <p id="posterDesc">
        Tippe auf „AR starten“, richte dein Gerät auf eine ebene Fläche und platziere dann das 3D-Modell.
      </p>
      <button id="startAr">AR starten</button>
    </div>
  </div>

  <!-- Versteckter model-viewer, nur als AR-Host -->
  <model-viewer id="mv"
    src="https://modelviewer.dev/shared-assets/models/Astronaut.glb"
    ar
    ar-modes="webxr scene-viewer quick-look"
    camera-controls
    environment-image="https://modelviewer.dev/shared-assets/environments/neutral.hdr"
    exposure="1"
    shadow-intensity="1"
    interaction-prompt="none"
    camera-orbit="0deg 70deg auto"
    camera-target="auto"
    field-of-view="30deg"
    poster="">
  </model-viewer>

  <script type="module">
  (() => {
    const qs = new URLSearchParams(location.search);
    const devParam = qs.get('dev');
    const DEV = qs.has('dev') && (devParam === null || devParam === '' || devParam === '1' || devParam === 'true');

    function bust(u){
      if (!DEV || !u) return u;
      const sep = u.includes('?') ? '&' : '?';
      return u + sep + 'v=' + Date.now();
    }

    // --------- URL-Parsing / Szenenpfade ---------
    let scene = (qs.get('scene') || qs.get('src') || '').trim();
    const workerBase = (qs.get('base') || 'https://area-publish.area-webar.workers.dev').replace(/\/$/, '');
    const overrideGlb  = (qs.get('glb')  || '').trim();
    const overrideUsdz = (qs.get('usdz') || '').trim();

    const isHttp = (u)=> /^https?:\/\//i.test(u);
    const isDataOrBlob = (u)=> u.startsWith('data:') || u.startsWith('blob:');
    const endsWithAny = (u,exts)=> exts.some(ext=> u.toLowerCase().endsWith(ext));

    let SCENE_GLB  = '';
    let SCENE_JSON = '';

    if (overrideGlb) {
      SCENE_GLB = overrideGlb;
    }

    if (scene) {
      if (isDataOrBlob(scene)) {
        SCENE_JSON = scene;
      } else if (isHttp(scene)) {
        if (endsWithAny(scene, ['.glb','.gltf'])) {
          if (!SCENE_GLB) SCENE_GLB = scene;
        } else {
          SCENE_JSON = scene;
        }
      } else {
        const id = scene.replace(/\/+$/,'');
        if (!SCENE_GLB) {
          SCENE_GLB = `${workerBase}/scenes/${encodeURIComponent(id)}/scene.glb`;
        }
        SCENE_JSON = `${workerBase}/scenes/${encodeURIComponent(id)}/scene.json`;
      }
    }

    // --------- DOM-Refs ---------
    const errBox      = document.getElementById('err');
    const mv          = document.getElementById('mv');
    const poster      = document.getElementById('poster');
    const startBtn    = document.getElementById('startAr');
    const posterTitle = document.getElementById('posterTitle');
    const posterDesc  = document.getElementById('posterDesc');

    function showError(msg){
      errBox.textContent = msg;
      errBox.style.display = 'block';
      console.error('[area-viewer]', msg);
    }

    // --------- Konfig mit Defaults ---------
    const cfg = {
      model:{ url: SCENE_GLB || "https://modelviewer.dev/shared-assets/models/Astronaut.glb", usdzUrl:null, animation:"*" },
      target:{ previewUrl:null },
      ui:{ showAR:true, arLabel:"AR starten" },
      animation:{ start:"onStart" } // onStart | onPlace | onClick | manual
    };

    // --------- Szene + JSON laden ---------
    (async () => {
      try {
        if (SCENE_JSON) {
          const r = await fetch(bust(SCENE_JSON), { cache:'no-cache' });
          if (!r.ok) throw new Error('scene.json: ' + r.status + ' ' + r.statusText);
          const j = await r.json();

          if (j.model)  Object.assign(cfg.model,  j.model);
          if (j.target) Object.assign(cfg.target, j.target);
          if (j.ui){
            if ('showAR'  in j.ui) cfg.ui.showAR  = !!j.ui.showAR;
            if (j.ui.arLabel)      cfg.ui.arLabel = String(j.ui.arLabel);
          }
          if (j.animation){
            if ('clipName' in j.animation) cfg.model.animation = j.animation.clipName;
            Object.assign(cfg.animation, j.animation);
          }

          // Optional: Poster-Texte/Artwork aus scene.json (wenn du das später ergänzt)
          if (j.meta?.title) posterTitle.textContent = j.meta.title;
          if (j.meta?.description) posterDesc.textContent = j.meta.description;
        }

        // finale GLB-URL: overrideGlb/SCENE_GLB hat Vorrang
        const finalGlb = SCENE_GLB || cfg.model.url || "https://modelviewer.dev/shared-assets/models/Astronaut.glb";
        mv.src = bust(finalGlb);

        const usdzUrl = overrideUsdz || cfg.model.usdzUrl;
        if (usdzUrl) mv.setAttribute('ios-src', usdzUrl);
        else mv.removeAttribute('ios-src');

        // poster-Image aus target.previewUrl könntest du später z. B. als Hintergrund verwenden

        if (!cfg.ui.showAR) {
          mv.removeAttribute('ar');
          startBtn.disabled = true;
          startBtn.textContent = 'AR nicht verfügbar';
        } else {
          startBtn.textContent = cfg.ui.arLabel || 'AR starten';
        }

      } catch(e){
        showError('Szene konnte nicht geladen werden: ' + e.message);
        console.error(e);
      }
    })();

    // --------- Animation initial konfigurieren, sobald GLB geladen ---------
    mv.addEventListener('load', () => {
      // Wir sehen den Preview nicht, aber der Zustand überträgt sich nach AR.
      const names = mv.availableAnimations || [];
      console.log('[area-viewer] availableAnimations:', names);

      const sel = cfg.model.animation;
      let chosen = null;

      if (sel === 'none') {
        chosen = null;
      } else if (sel === '*' || sel === null || typeof sel === 'undefined') {
        chosen = names[0] || null;
      } else if (typeof sel === 'string') {
        if (/^\d+$/.test(sel)) {
          const idx = Math.max(0, Math.min(names.length-1, parseInt(sel,10)));
          chosen = names[idx] || null;
        } else {
          chosen = names.includes(sel) ? sel : (names[0] || null);
        }
      } else if (Number.isFinite(sel)) {
        const idx = Math.max(0, Math.min(names.length-1, sel|0));
        chosen = names[idx] || null;
      }

      const startModeRaw = (cfg.animation && cfg.animation.start) ? String(cfg.animation.start) : 'onStart';
      const startMode = startModeRaw.toLowerCase();
      console.log('[area-viewer] chosen:', chosen, 'startMode:', startMode);

      if (chosen == null) {
        mv.animationName = null;
        mv.autoplay = false;
      } else {
        mv.animationName = chosen;
      }

      // Wichtig: nur der Startzustand zählt, da wir kein Preview brauchen.
      // - onStart  → animiert
      // - manual/onPlace/onClick → pausiert, Frame 0
      if (startMode === 'manual' || startMode === 'onplace' || startMode === 'onclick') {
        mv.autoplay = false;
        try { mv.pause(); } catch {}
        try { mv.currentTime = 0; } catch {}
      } else {
        mv.autoplay = !!chosen;
        if (mv.autoplay && typeof mv.play === 'function') {
          try { mv.play(); } catch {}
        }
      }
    });

    // --------- AR-Start über den Poster-Button ---------
    startBtn.addEventListener('click', async (ev) => {
      ev.preventDefault();
      ev.stopPropagation();

      if (!mv.hasAttribute('ar')) {
        showError('AR ist für diese Szene nicht aktiviert.');
        return;
      }

      startBtn.disabled = true;

      try {
        // Poster ausblenden
        poster.style.display = 'none';

        // AR-Modus starten (Quick Look / Scene Viewer / WebXR – je nach Plattform)
        if (typeof mv.activateAR === 'function') {
          await mv.activateAR();
        } else if (typeof mv.enterAR === 'function') {
          await mv.enterAR();
        } else {
          throw new Error('AR wird von diesem Browser nicht unterstützt.');
        }
      } catch (e) {
        showError('AR konnte nicht gestartet werden: ' + e.message);
        console.error('[area-viewer] AR start error', e);
        // Poster wieder zeigen, damit der User nicht im schwarzen Loch hängt
        poster.style.display = 'flex';
      } finally {
        startBtn.disabled = false;
      }
    });

  })();
  </script>
</body>
</html>
