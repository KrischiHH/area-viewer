<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ARea Viewer â€“ Surface AR</title>

  <!-- model-viewer von Google -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <style>
    :root{color-scheme:dark light}
    *,*::before,*::after{box-sizing:border-box}
    html,body{
      margin:0;
      height:100%;
      background:#000;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif
    }
    model-viewer{
      position:fixed;
      inset:0;
      width:100vw;
      height:100svh;
      display:block;
      background:#000;
    }
    button[slot="ar-button"]{
      position:absolute;
      left:max(12px,env(safe-area-inset-left));
      top:max(12px,env(safe-area-inset-top));
      padding:.75rem 1rem;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.25);
      background:#111;
      color:#fff;
      font-size:14px;
      cursor:pointer;
    }
    #hud{
      position:fixed;
      right:max(12px,env(safe-area-inset-right));
      bottom:max(12px,env(safe-area-inset-bottom));
      display:flex;
      gap:8px;
      z-index:3;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.18);
      padding:6px 8px;
      border-radius:999px;
      backdrop-filter:blur(8px);
      align-items:center;
    }
    #hud.hidden{display:none}
    #hud button{
      all:unset;
      cursor:pointer;
      padding:6px 10px;
      border-radius:999px;
      color:#fff;
      user-select:none;
      font-size:13px;
      border:1px solid rgba(255,255,255,0.25);
      background:rgba(0,0,0,0.35);
    }
    #err{
      position:fixed;
      left:12px;
      top:12px;
      z-index:9;
      background:#b00020;
      color:#fff;
      padding:8px 10px;
      border-radius:8px;
      display:none;
      font:12px/1.35 monospace;
      max-width:min(92vw,680px);
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <div id="err"></div>

  <model-viewer id="mv"
    src="https://modelviewer.dev/shared-assets/models/Astronaut.glb"
    ar
    ar-modes="webxr scene-viewer quick-look"
    camera-controls
    environment-image="https://modelviewer.dev/shared-assets/environments/neutral.hdr"
    exposure="1"
    shadow-intensity="1"
    interaction-prompt="none"
    camera-orbit="0deg 70deg auto"
    camera-target="auto"
    field-of-view="30deg"
    poster="">
    <button slot="ar-button" id="arBtn">In AR Ã¶ffnen</button>
  </model-viewer>

  <div id="hud" class="hidden">
    <button id="btnPlay" title="Play/Pause">â–¶ï¸Ž</button>
    <button id="btnMute" title="Ton an/aus">ðŸ”Š</button>
  </div>

  <script type="module">
  (() => {
    const qs = new URLSearchParams(location.search);
    const devParam = qs.get('dev');
    const DEV = qs.has('dev') && (devParam === null || devParam === '' || devParam === '1' || devParam === 'true');

    function bust(u){
      if (!DEV || !u) return u;
      const sep = u.includes('?') ? '&' : '?';
      return u + sep + 'v=' + Date.now();
    }

    // --------- URL-Parsing / Szenenpfade ---------
    let scene = (qs.get('scene') || qs.get('src') || '').trim();
    const workerBase = (qs.get('base') || 'https://area-publish.area-webar.workers.dev').replace(/\/$/, '');
    const overrideGlb  = (qs.get('glb')  || '').trim();
    const overrideUsdz = (qs.get('usdz') || '').trim();

    const isHttp = (u)=> /^https?:\/\//i.test(u);
    const isDataOrBlob = (u)=> u.startsWith('data:') || u.startsWith('blob:');
    const endsWithAny = (u,exts)=> exts.some(ext=> u.toLowerCase().endsWith(ext));

    let SCENE_GLB  = '';
    let SCENE_JSON = '';

    if (overrideGlb) {
      SCENE_GLB = overrideGlb;
    }

    if (scene) {
      if (isDataOrBlob(scene)) {
        SCENE_JSON = scene;
      } else if (isHttp(scene)) {
        if (endsWithAny(scene, ['.glb','.gltf'])) {
          if (!SCENE_GLB) SCENE_GLB = scene;
        } else {
          SCENE_JSON = scene;
        }
      } else {
        const id = scene.replace(/\/+$/,'');
        if (!SCENE_GLB) {
          SCENE_GLB = `${workerBase}/scenes/${encodeURIComponent(id)}/scene.glb`;
        }
        SCENE_JSON = `${workerBase}/scenes/${encodeURIComponent(id)}/scene.json`;
      }
    }

    // --------- DOM-Refs ---------
    const errBox = document.getElementById('err');
    const mv     = document.getElementById('mv');
    const hud    = document.getElementById('hud');
    const btnPlay= document.getElementById('btnPlay');
    const btnMute= document.getElementById('btnMute');
    const arBtn  = document.getElementById('arBtn');

    function showError(msg){
      errBox.textContent = msg;
      errBox.style.display = 'block';
      console.error('[area-viewer]', msg);
    }

    // --------- Konfig mit Defaults ---------
    const cfg = {
      model:{ url: SCENE_GLB || "https://modelviewer.dev/shared-assets/models/Astronaut.glb", usdzUrl:null, animation:"*" },
      target:{ previewUrl:null },
      audio:{ src:null, autoplay:"withAnimation", loop:true, volume:0.85 },
      ui:{ showPlayPause:false, showMute:false, showAR:true, arLabel:"In AR Ã¶ffnen" },
      animation:{ start:"onStart" } // onStart | onPlace | onClick | manual
    };

    let uiExplicitPlayPause = false;
    let uiExplicitMute      = false;

    let audio = null;
    let audioReady = false;
    let muted = false;

    function setupAudio(){
      if (!cfg.audio?.src) return;
      audio = new Audio(cfg.audio.src);
      audio.crossOrigin = "anonymous";
      audio.loop = !!cfg.audio.loop;
      audio.volume = Number.isFinite(cfg.audio.volume) ? cfg.audio.volume : 0.85;
      audioReady = true;
    }

    function setMuted(on){
      muted = !!on;
      if (audio && audioReady) audio.muted = muted;
      btnMute.textContent = muted ? 'ðŸ”ˆ' : 'ðŸ”Š';
    }

    function togglePlay(){
      // Nur sinnvoll, wenn eine Animation gesetzt ist
      if (!mv.animationName) return;
      try {
        if (mv.paused) {
          mv.play();
        } else {
          mv.pause();
        }
      } catch(e){
        console.warn('[area-viewer] togglePlay fehlgeschlagen:', e);
      }
    }

    let currentStartMode = 'onstart'; // wird im load-Handler gesetzt

    // AR-Button: Animationszustand *vor* AR-Start fixen
    arBtn?.addEventListener('click', () => {
      const mode = currentStartMode;
      try {
        if (mode === 'onplace' || mode === 'manual' || mode === 'onclick') {
          mv.autoplay = false;
          if (typeof mv.pause === 'function') mv.pause();
          if (typeof mv.currentTime === 'number') mv.currentTime = 0;
        } else if (mode === 'onstart') {
          if (mv.animationName) {
            mv.autoplay = true;
            if (typeof mv.play === 'function') mv.play();
          }
        }
      } catch(e){
        console.warn('[area-viewer] Konnte Animation vor AR-Start nicht setzen:', e);
      }
    });

    // --------- Szene + JSON laden ---------
    (async () => {
      try {
        if (SCENE_GLB) {
          mv.src = bust(SCENE_GLB);
        }

        if (SCENE_JSON) {
          const r = await fetch(bust(SCENE_JSON), { cache:'no-cache' });
          if (!r.ok) throw new Error('scene.json: ' + r.status + ' ' + r.statusText);
          const j = await r.json();

          if (j.model)  Object.assign(cfg.model,  j.model);
          if (j.target) Object.assign(cfg.target, j.target);
          if (j.audio)  Object.assign(cfg.audio,  j.audio);

          if (j.ui){
            if ('showPlayPause' in j.ui){ cfg.ui.showPlayPause = !!j.ui.showPlayPause; uiExplicitPlayPause=true; }
            if ('showMute'      in j.ui){ cfg.ui.showMute      = !!j.ui.showMute;      uiExplicitMute=true; }
            if ('showAR'        in j.ui) cfg.ui.showAR = !!j.ui.showAR;
            if (j.ui.arLabel)           cfg.ui.arLabel = String(j.ui.arLabel);
            if (j.ui.controls){
              if ('showPlay' in j.ui.controls){ cfg.ui.showPlayPause = !!j.ui.controls.showPlay; uiExplicitPlayPause=true; }
              if ('showMute' in j.ui.controls){ cfg.ui.showMute      = !!j.ui.controls.showMute; uiExplicitMute=true; }
            }
          }

          if (j.animation){
            if ('clipName' in j.animation) cfg.model.animation = j.animation.clipName;
            Object.assign(cfg.animation, j.animation);
          }

          // Falls SCENE_GLB leer war, aber in JSON eine URL steht:
          if (!SCENE_GLB && cfg.model.url) {
            mv.src = bust(cfg.model.url);
          }
        }

        // model-viewer-Attribute final setzen
        const finalGlb = cfg.model.url || SCENE_GLB || "https://modelviewer.dev/shared-assets/models/Astronaut.glb";
        mv.src = bust(finalGlb);

        const usdzUrl = overrideUsdz || cfg.model.usdzUrl;
        if (usdzUrl) mv.setAttribute('ios-src', usdzUrl);
        else mv.removeAttribute('ios-src');

        if (cfg.target?.previewUrl) mv.setAttribute('poster', cfg.target.previewUrl);
        else mv.removeAttribute('poster');

        if (!cfg.ui.showAR) {
          mv.removeAttribute('ar');
          if (arBtn) arBtn.style.display = 'none';
        } else {
          if (arBtn) {
            arBtn.textContent = cfg.ui.arLabel || 'In AR Ã¶ffnen';
            arBtn.style.display = '';
          }
        }

        if (cfg.audio?.src) setupAudio();

        const showMuteInitial = uiExplicitMute ? cfg.ui.showMute : !!cfg.audio?.src;
        btnMute.style.display = showMuteInitial ? '' : 'none';

      } catch(e){
        showError('Szene konnte nicht geladen werden: ' + e.message);
        console.error(e);
      }
    })();

    // --------- Wenn Modell geladen ist: Animation & HUD konfigurieren ---------
    mv.addEventListener('load', () => {
      // Kamera-Basis
      mv.cameraOrbit  = '0deg 70deg auto';
      mv.cameraTarget = 'auto';
      mv.fieldOfView  = '30deg';
      try { mv.jumpCameraToGoal(); } catch {}

      const names = mv.availableAnimations || [];
      console.log('[area-viewer] availableAnimations:', names);

      // Animation wÃ¤hlen
      const sel = cfg.model.animation;
      let chosen = null;

      if (sel === 'none') {
        chosen = null;
      } else if (sel === '*' || sel === null || typeof sel === 'undefined') {
        chosen = names[0] || null;
      } else if (typeof sel === 'string') {
        if (/^\d+$/.test(sel)) {
          const idx = Math.max(0, Math.min(names.length-1, parseInt(sel,10)));
          chosen = names[idx] || null;
        } else {
          chosen = names.includes(sel) ? sel : (names[0] || null);
        }
      } else if (Number.isFinite(sel)) {
        const idx = Math.max(0, Math.min(names.length-1, sel|0));
        chosen = names[idx] || null;
      }

      const startModeRaw = (cfg.animation && cfg.animation.start) ? String(cfg.animation.start) : 'onStart';
      const startMode = startModeRaw.toLowerCase();
      currentStartMode = startMode;
      console.log('[area-viewer] chosen:', chosen, 'startMode:', startMode);

      if (chosen == null) {
        mv.animationName = null;
        mv.autoplay = false;
      } else {
        mv.animationName = chosen;
      }

      // Startverhalten:
      // - onStart: Preview & AR starten animiert
      // - manual / onPlace / onClick: Preview & AR starten pausiert, nur via Button
      if (startMode === 'manual' || startMode === 'onplace' || startMode === 'onclick') {
        mv.autoplay = false;
        try { mv.pause(); } catch {}
      } else {
        mv.autoplay = !!chosen;
        if (mv.autoplay && typeof mv.play === 'function') {
          try { mv.play(); } catch {}
        }
      }

      // HUD-Sichtbarkeit
      const showPlay = uiExplicitPlayPause ? cfg.ui.showPlayPause : (names.length > 0);
      btnPlay.style.display = showPlay ? '' : 'none';
      const anyHud = (btnPlay.style.display !== 'none') || (btnMute.style.display !== 'none');
      hud.classList.toggle('hidden', !anyHud);

      // Audio an Animation koppeln
      if (audio && cfg.audio.autoplay === 'auto') {
        const kick = ()=>{ try{ audio.play(); }catch{} };
        window.addEventListener('pointerdown', kick, { once:true });
      }

      mv.addEventListener('play', () => {
        if (audio && cfg.audio.autoplay === 'withAnimation' && !audio.muted){
          try{ audio.play(); }catch{}
        }
        btnPlay.textContent = 'â¸';
      });

      mv.addEventListener('pause', () => {
        if (audio && cfg.audio.autoplay === 'withAnimation' && !audio.paused){
          try{ audio.pause(); }catch{}
        }
        btnPlay.textContent = 'â–¶ï¸Ž';
      });
    });

    // HUD-Buttons
    btnPlay.addEventListener('click', () => togglePlay());
    btnMute.addEventListener('click', () => setMuted(!muted));

  })();
  </script>
</body>
</html>
