<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ARea – Guided AR Viewer</title>
  <meta name="theme-color" content="#0b1323" />
  <style>
    :root{
      --bg:#0b1323; --panel:#0f1626; --text:#e9eefb; --muted:#a7b4d6; --border:#1f2940;
      --accent:#7aa2ff; --accent2:#5eead4; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:#000;color:var(--text);font:14px/1.45 system-ui, Segoe UI, Inter, Roboto, Arial, sans-serif}
    canvas{display:block}

    /* DOM Overlay Root for WebXR */
    #overlayRoot{position:fixed; inset:0; pointer-events:none; z-index:10;}

    /* Preflight (Poster) */
    #preflight{position:absolute; inset:0; display:grid; place-items:center; padding:24px; pointer-events:auto;}
    #preflightCard{
      width:min(720px,92vw); border:1px solid var(--border); border-radius:16px; overflow:hidden;
      background:color-mix(in srgb, var(--panel) 82%, transparent);
      box-shadow:0 18px 48px rgba(0,0,0,.5);
      backdrop-filter:saturate(1.1) blur(8px);
    }
    .poster{width:100%; display:block; background:#000; object-fit:cover; aspect-ratio:16/9}
    .pbody{padding:14px 14px 16px}
    .eyebrow{font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.12em}
    .title{font-weight:800; font-size:18px; margin:4px 0}
    .desc{color:var(--muted)}
    .prow{display:flex; gap:10px; justify-content:flex-end; margin-top:12px}
    .btn{background:var(--panel); border:1px solid var(--border); color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:800}
    .btn:hover{border-color:var(--accent)}
    .btn.primary{background:linear-gradient(180deg, color-mix(in srgb, var(--panel) 78%, var(--accent) 22%), color-mix(in srgb, var(--panel) 85%, var(--accent2) 15%));}

    /* Bottom HUD */
    #hud{position:absolute; left:0; right:0; bottom:env(safe-area-inset-bottom); padding:10px; display:flex; justify-content:center; pointer-events:auto}
    #hud .bar{display:flex; gap:8px; padding:8px; border:1px solid var(--border); border-radius:999px; background:color-mix(in srgb, var(--panel) 86%, transparent); box-shadow:0 10px 24px rgba(0,0,0,.35)}
    .iconbtn{display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:999px; border:1px solid var(--border); background:color-mix(in srgb, var(--panel) 92%, transparent); color:var(--text); font-weight:800; cursor:pointer}
    .iconbtn[hidden]{display:none}
    .iconbtn:hover{border-color:var(--accent)}
    .iconbtn .ico{width:16px; height:16px; background:currentColor; -webkit-mask:var(--m) no-repeat center/contain; mask:var(--m) no-repeat center/contain}
    .danger{border-color:#6b1a1a; color:#ffdede}

    /* Small status pill (top-right) */
    #status{position:absolute; top:12px; right:12px; pointer-events:none; background:color-mix(in srgb, var(--panel) 85%, transparent); border:1px solid var(--border); color:var(--muted); border-radius:12px; padding:6px 10px; font-size:12px}

    /* Scan overlay */
    #scanOverlay{position:absolute; inset:0; display:grid; place-items:center; pointer-events:none;}
    #scanOverlay[hidden]{display:none}
    .scanBubble{display:flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:color-mix(in srgb, var(--panel) 86%, transparent); box-shadow:0 10px 24px rgba(0,0,0,.35); font-weight:800;}
    .scanBubble .dot{width:10px; height:10px; border-radius:50%; background:var(--accent); animation:pulse 1.2s infinite;}
    @keyframes pulse{0%{opacity:.25;transform:scale(.9)}50%{opacity:1;transform:scale(1.1)}100%{opacity:.25;transform:scale(.9)}}

    /* Big blocking notice (e.g., in-app browser) */
    #blocker{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.6); z-index:9999; pointer-events:auto}
    #blocker .card{max-width:640px; margin:20px; padding:16px; border:1px solid var(--border); border-radius:16px; background:color-mix(in srgb, var(--panel) 92%, transparent)}
    #blocker pre{white-space:pre-wrap; font:13px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color:var(--muted)}

    /* Tiny toast */
    #toast{position:fixed; right:12px; bottom:12px; background:color-mix(in srgb, var(--panel) 92%, transparent); border:1px solid var(--border); border-radius:10px; padding:10px 12px; display:none; z-index:9999}

    /* Hide if not needed */
    [hidden]{display:none !important}
  </style>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>
<body>
  <!-- WebGL canvas is created by THREE -->
  <div id="overlayRoot">
    <div id="preflight">
      <div id="preflightCard">
        <img id="poster" class="poster" alt="Poster" />
        <div class="pbody">
          <div id="eyebrow" class="eyebrow">ARea – Szene</div>
          <div id="title" class="title">Titel der Szene</div>
          <div id="desc" class="desc">Tippe auf OK, erlaube die Kamera und bewege das Gerät, bis eine Fläche erkannt wurde. Dann blendet diese Karte weich aus.</div>
          <div class="prow">
            <button id="btn-open-native" class="btn" hidden>In AR (nativ) öffnen</button>
            <button id="btn-start" class="btn primary">OK</button>
          </div>
        </div>
      </div>
    </div>

    <div id="scanOverlay" hidden>
      <div class="scanBubble"><span class="dot"></span> Umgebung scannen…</div>
    </div>

    <div id="hud" hidden>
      <div class="bar">
        <button id="btn-place" class="iconbtn" title="Platzieren"><span class="ico" style="--m:url('data:image/svg+xml,%3Csvg viewBox=\'0 0 24 24\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M12 2l7 4v6c0 5-7 10-7 10S5 17 5 12V6l7-4z\' fill=\'%23fff\'/%3E%3C/svg%3E')"></span>Platzieren</button>
        <button id="btn-reset" class="iconbtn" title="Neu ausrichten"><span class="ico" style="--m:url('data:image/svg+xml,%3Csvg viewBox=\'0 0 24 24\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M12 5V1L7 6l5 5V7c3.309 0 6 2.691 6 6a6 6 0 11-6-6z\' fill=\'%23fff\'/%3E%3C/svg%3E')"></span>Reset</button>
        <button id="btn-rot-l" class="iconbtn" title="Drehen -15°"><span class="ico" style="--m:url('data:image/svg+xml,%3Csvg viewBox=\'0 0 24 24\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M12 2a10 10 0 1010 10h-2a8 8 0 11-8-8V2zM11 6v6l5 3\' stroke=\'%23fff\' stroke-width=\'2\' fill=\'none\'/%3E%3C/svg%3E')"></span></button>
        <button id="btn-rot-r" class="iconbtn" title="Drehen +15°"><span class="ico" style="--m:url('data:image/svg+xml,%3Csvg viewBox=\'0 0 24 24\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M12 2a10 10 0 1010 10h-2a8 8 0 11-8-8V2zM13 6v6l-5 3\' stroke=\'%23fff\' stroke-width=\'2\' fill=\'none\'/%3E%3C/svg%3E')"></span></button>
        <button id="btn-scale-dn" class="iconbtn" title="Kleiner"><span class="ico" style="--m:url('data:image/svg+xml,%3Csvg viewBox=\'0 0 24 24\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M5 12h14\' stroke=\'%23fff\' stroke-width=\'2\'/%3E%3C/svg%3E')"></span></button>
        <button id="btn-scale-up" class="iconbtn" title="Größer"><span class="ico" style="--m:url('data:image/svg+xml,%3Csvg viewBox=\'0 0 24 24\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M12 5v14M5 12h14\' stroke=\'%23fff\' stroke-width=\'2\'/%3E%3C/svg%3E')"></span></button>
        <button id="btn-play" class="iconbtn" title="Play/Pause" hidden><span class="ico" style="--m:url('data:image/svg+xml,%3Csvg viewBox=\'0 0 24 24\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M8 5v14l11-7z\' fill=\'%23fff\'/%3E%3C/svg%3E')"></span></button>
        <button id="btn-mute" class="iconbtn" title="Mute" hidden><span class="ico" style="--m:url('data:image/svg+xml,%3Csvg viewBox=\'0 0 24 24\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M3 9v6h4l5 5V4L7 9H3z\' fill=\'%23fff\'/%3E%3C/svg%3E')"></span></button>
      </div>
    </div>

    <div id="status">Warte auf AR…</div>
  </div>

  <div id="blocker">
    <div class="card">
      <h3>AR nicht verfügbar in diesem Browser</h3>
      <p>Bitte öffne den Link in <b>Google Chrome</b> (nicht in der App-Webansicht). Tippe rechts oben auf „⋯“ → <b>In Chrome öffnen</b>.</p>
      <pre id="blockerDetails"></pre>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <button class="btn" id="blockerClose">Schließen</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';

    // ---------- tiny utils ----------
    const $ = sel => document.querySelector(sel);
    function toast(msg){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',2400); }
    function qs(key){ return new URL(location.href).searchParams.get(key); }
    const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const isInApp = /Instagram|FBAN|FBAV|Line|WeChat|MiuiBrowser|Twitter|TikTok|wv/.test(navigator.userAgent);

    // Resolve scene config
    async function loadConfig(){
      const src = qs('src');
      if (src){
        const text = decodeURIComponent(src.split(',')[1]||'');
        return JSON.parse(text);
      }
      const sceneId = qs('scene');
      const base  = qs('base') || 'https://area-publish.area-webar.workers.dev';
      if (!sceneId) throw new Error('Kein scene oder src angegeben');
      const url = `${base.replace(/\/$/,'')}/scenes/${encodeURIComponent(sceneId)}/scene.json`;
      const res = await fetch(url, { cache:'no-store' });
      if (!res.ok) throw new Error('scene.json nicht gefunden');
      const json = await res.json();
      json.__base = `${base.replace(/\/$/,'')}/scenes/${encodeURIComponent(sceneId)}`;
      return json;
    }

    function resolveUrl(maybeRel, cfg){
      if (!maybeRel) return '';
      if (/^https?:|^data:|^blob:/.test(maybeRel)) return maybeRel;
      const b = (cfg.__base || '').replace(/\/$/,'');
      return b ? `${b}/${maybeRel.replace(/^\//,'')}` : maybeRel;
    }

    // ---------- THREE setup ----------
    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true, preserveDrawingBuffer:false, powerPreference:'high-performance' });
    renderer.setPixelRatio(Math.min(devicePixelRatio||1, 2));
    renderer.setSize(innerWidth, innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.1;
    document.body.prepend(renderer.domElement);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, innerWidth/innerHeight, 0.01, 50);
    const light = new THREE.HemisphereLight(0xffffff, 0x334466, 1.2); scene.add(light);
    const dir   = new THREE.DirectionalLight(0xffffff, 1.8); dir.position.set(0,3,1); scene.add(dir);

    window.addEventListener('resize', ()=>{
      renderer.setSize(innerWidth, innerHeight);
      camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix();
    });

    // Reticle
    const reticle = new THREE.Mesh(
      new THREE.RingGeometry(0.09, 0.1, 32).rotateX(-Math.PI/2),
      new THREE.MeshBasicMaterial({ color:0x88ccff, transparent:true, opacity:0.85 })
    );
    reticle.matrixAutoUpdate = false;
    reticle.visible = false;
    scene.add(reticle);

    // Model state
    let model = null, previewModel = null, mixer = null, audio = null;
    let placed = false, baseScale = 1;
    let CFG = null;

    const loader = new GLTFLoader();
    const draco = new DRACOLoader(); draco.setDecoderPath('https://www.gstatic.com/draco/v1/decoders/'); loader.setDRACOLoader(draco);

    // Animation helpers
    function startAnimation(cfg){
      if (!mixer || !model) return;
      const clips = model.animations || [];
      if (!clips.length) return;
      const want = (cfg.animation?.clipName)||'*';
      const clip = (want && want!=='*') ? (clips.find(c=>c.name===want)||clips[0]) : clips[0];
      const act = mixer.clipAction(clip);
      const loop = cfg.animation?.loop !== false;
      act.setLoop(loop ? THREE.LoopRepeat : THREE.LoopOnce, loop ? (cfg.animation?.iterations||9999) : 0);
      act.clampWhenFinished = true;
      act.reset().play();
      if (cfg.audio?.autoplay === 'withAnimation' && audio && !audio.isPlaying) audio.play();
    }
    function pauseAnimationAndAudio(){
      if (mixer) mixer.timeScale = 0;
      if (CFG?.audio?.autoplay === 'withAnimation' && audio?.isPlaying) audio.stop();
    }

    // AR session / hit-test
    let xrSession = null, refSpace = null, viewerSpace = null, hitTestSource = null;
    const clock = new THREE.Clock();

    function updateScanOverlay(){
      $('#scanOverlay').hidden = !(xrSession && !placed && (!reticle.visible || !model));
    }

    function humanizeXRError(e){
      const m = (e && (e.message||e.name||e.toString())) || 'Unbekannter Fehler';
      if (/NotAllowedError|Permission/.test(m)) return 'Kamerazugriff verweigert. Erlaube die Kamera im Browser (Schloss-Icon) und lade neu.';
      if (/NotFoundError/.test(m)) return 'Keine Kamera gefunden. Starte das Gerät neu.';
      if (/NotSupported|Unsupported/.test(m)) return 'AR nicht unterstützt. Prüfe Chrome-Update & „Google Play Services for AR“ (ARCore) im Play-Store.';
      if (/SecurityError/.test(m)) return 'Sichere Umgebung erforderlich. Öffne die Seite direkt in Chrome über HTTPS.';
      return m;
    }

    async function startXR(cfg){
      if (!navigator.xr) throw new Error('WebXR in diesem Browser nicht verfügbar.');
      const supported = await navigator.xr.isSessionSupported('immersive-ar');
      if (!supported) throw new Error('AR-Session wird nicht unterstützt (evtl. ARCore fehlt oder In-App-Browser).');

      const overlayRoot = document.getElementById('overlayRoot');
      const init = { requiredFeatures:['hit-test'], optionalFeatures:['dom-overlay'], domOverlay:{ root: overlayRoot } };
      const sess = await navigator.xr.requestSession('immersive-ar', init);
      xrSession = sess;
      renderer.xr.enabled = true;
      await renderer.xr.setSession(sess);
      refSpace = await sess.requestReferenceSpace('local');
      viewerSpace = await sess.requestReferenceSpace('viewer');
      hitTestSource = await sess.requestHitTestSource({ space: viewerSpace });

      // Tap to place
      sess.addEventListener('select', ()=>{
        if (!reticle.visible || !previewModel) return;
        const m = new THREE.Matrix4(); m.copy(reticle.matrix);
        model.matrix.copy(m); model.matrix.decompose(model.position, model.quaternion, model.scale);
        placed = true; previewModel.visible = false; $('#btn-place').textContent='Neu platzieren';
        if (cfg.animation?.start === 'onStart') startAnimation(cfg);
        updateScanOverlay();
      });

      // Render loop
      renderer.setAnimationLoop((time, frame)=>{
        if (!frame) return;
        const ht = frame.getHitTestResults(hitTestSource);
        if (ht.length){
          const hit = ht[0];
          const m = new THREE.Matrix4().fromArray(hit.getPose(refSpace).transform.matrix);
          reticle.visible = true; reticle.matrix.copy(m);
          if (!placed && previewModel){
            previewModel.visible = true;
            previewModel.matrix.copy(m);
            previewModel.matrix.decompose(previewModel.position, previewModel.quaternion, previewModel.scale);
          }
        } else {
          reticle.visible = false;
          if (!placed && previewModel) previewModel.visible = false;
        }

        const dt = clock.getDelta();
        mixer && mixer.update(dt);
        renderer.render(scene, camera);

        if (!document.body.__preflightGone && reticle.visible && model) hidePreflight();
        updateScanOverlay();
      });
    }

    function hidePreflight(){
      const pf = $('#preflight');
      if (!pf || document.body.__preflightGone) return;
      pf.style.transition = 'opacity .35s ease';
      pf.style.opacity = '0';
      setTimeout(()=>{ pf.hidden = true; document.body.__preflightGone = true; }, 360);
      $('#hud').hidden = false;
      $('#status').textContent = 'Tippe, um zu platzieren';
      updateScanOverlay();
    }

    // Load model + optional audio
    async function loadModel(cfg){
      const glbUrl = resolveUrl(cfg.model?.url||'scene.glb', cfg);
      const gltf = await loader.loadAsync(glbUrl);
      const root = gltf.scene || gltf.scenes?.[0];
      root.updateMatrixWorld(true);

      model = new THREE.Group(); model.name = 'ModelRoot'; model.add(root);
      model.traverse(n=>{ if (n.material){ n.material.transparent = (n.material.transparent||false); } });
      scene.add(model);

      previewModel = model.clone(true);
      previewModel.traverse(n=>{
        if (n.material){
          const m = n.material.clone(); m.transparent = true; m.opacity = 0.6; m.depthWrite = false; n.material = m;
        }
      });
      scene.add(previewModel);

      baseScale = cfg.model?.scale || 1;
      model.scale.setScalar(baseScale);
      previewModel.scale.setScalar(baseScale);

      if (gltf.animations?.length){
        model.animations = gltf.animations;
        mixer = new THREE.AnimationMixer(root);
        const showPlay = (cfg.animation?.start === 'onClick');
        $('#btn-play').hidden = !showPlay;
        if (!showPlay && cfg.animation?.start === 'onStart' && placed) startAnimation(cfg);
      } else {
        $('#btn-play').hidden = true;
      }

      if (cfg.audio?.url){
        const listener = new THREE.AudioListener(); camera.add(listener);
        const sound = new THREE.Audio(listener);
        const url = resolveUrl(cfg.audio.url, cfg);
        const res = await fetch(url); const buff = await res.arrayBuffer();
        const ctx = listener.context; const abuf = await ctx.decodeAudioData(buff);
        sound.setBuffer(abuf); sound.setLoop(!!cfg.audio.loop); sound.setVolume(0.85);
        audio = sound; model.add(sound);
        $('#btn-mute').hidden = false;
      } else {
        $('#btn-mute').hidden = true;
      }

      updateScanOverlay();
      return model;
    }

    // Controls
    function setScale(f){ if (!model) return; const s = THREE.MathUtils.clamp(model.scale.x * f, 0.05, 20); model.scale.setScalar(s); previewModel?.scale.setScalar(s); }
    function rotateY(deg){ if (!model) return; const r = THREE.MathUtils.degToRad(deg); model.rotation.y += r; previewModel && (previewModel.rotation.y += r); }

    // HUD events
    $('#btn-scale-up').onclick = ()=> setScale(1.1);
    $('#btn-scale-dn').onclick = ()=> setScale(1/1.1);
    $('#btn-rot-l').onclick = ()=> rotateY(-15);
    $('#btn-rot-r').onclick = ()=> rotateY(+15);
    $('#btn-reset').onclick = ()=>{ placed=false; previewModel.visible=true; $('#btn-place').textContent='Platzieren'; updateScanOverlay(); };
    $('#btn-place').onclick = ()=>{ if (!placed){ toast('Tippe in die Szene, um zu platzieren'); } else { placed=false; previewModel.visible=true; $('#btn-place').textContent='Platzieren'; updateScanOverlay(); } };
    $('#btn-play').onclick = ()=>{
      if (!mixer || !model?.animations?.length) return;
      const ts = mixer.timeScale ?? 1;
      if (ts === 0){ mixer.timeScale = 1; if (CFG?.audio?.autoplay === 'withAnimation' && audio && !audio.isPlaying) audio.play(); }
      else { pauseAnimationAndAudio(); }
    };
    $('#btn-mute').onclick = ()=>{ if (audio){ audio.setVolume(audio.getVolume() > 0 ? 0 : 0.85); } };

    // Touch gestures: pinch to scale, rotate
    const touches = new Map(); let g0=null;
    const dist=(a,b)=>Math.hypot(a.clientX-b.clientX, a.clientY-b.clientY);
    const ang =(a,b)=>Math.atan2(b.clientY-a.clientY, b.clientX-a.clientX);
    addEventListener('pointerdown', e=>{ touches.set(e.pointerId,{clientX:e.clientX,clientY:e.clientY}); }, {passive:true});
    addEventListener('pointermove', e=>{
      if (!touches.has(e.pointerId)) return;
      touches.set(e.pointerId,{clientX:e.clientX,clientY:e.clientY});
      if (placed && touches.size===2 && model){
        const [t1,t2]=[...touches.values()];
        const d=dist(t1,t2), a=ang(t1,t2);
        if (!g0){ g0={d,a,scale:model.scale.x,rot:model.rotation.y}; return; }
        model.scale.setScalar(THREE.MathUtils.clamp(g0.scale*(d/g0.d),0.05,20));
        model.rotation.y = g0.rot + (a-g0.a);
      }
    }, {passive:true});
    const endG=()=>{ if (touches.size<2) g0=null; };
    addEventListener('pointerup', e=>{ touches.delete(e.pointerId); endG(); }, {passive:true});
    addEventListener('pointercancel', e=>{ touches.delete(e.pointerId); endG(); }, {passive:true});

    // Native fallback link
    function buildNativeLink(cfg){
      const glb = resolveUrl(cfg.model?.url||'', cfg);
      const usdz = resolveUrl(cfg.model?.usdzUrl||'', cfg);
      if (isiOS && usdz) return usdz; // iOS Quick Look
      const file = encodeURIComponent(glb);
      const title = encodeURIComponent(cfg.meta?.title || 'ARea Model');
      // note: Scene Viewer ignoriert Audio; spielt i.d.R. die erste Animation nach Platzierung
      return `intent://arvr.google.com/scene-viewer/1.0?file=${file}&mode=ar_preferred&title=${title}#Intent;scheme=https;package=com.google.android.googlequicksearchbox;end;`;
    }
    function shouldShowNativeCTA(cfg){
      const pref = cfg.ui?.welcome?.nativeCta ?? "ios-only";
      if (pref === "never") return false;
      if (pref === "always") return true;
      if (pref === "ios-only") return isiOS && !!cfg.model?.usdzUrl;
      return false;
    }

    function showBlocker(msg, details=''){
      $('#blocker').style.display='grid';
      $('#blockerDetails').textContent = (details? (details+'\n') : '') + msg;
    }
    $('#blockerClose').onclick = ()=> $('#blocker').style.display='none';

    // Main
    (async function(){
      const cfg = await loadConfig(); CFG = cfg;

      // Apply UI text & poster
      $('#eyebrow').textContent = cfg.ui?.welcome?.eyebrow || 'ARea – Szene';
      $('#title').textContent   = cfg.ui?.welcome?.title   || cfg.meta?.title || 'Scene';
      $('#desc').textContent    = cfg.ui?.welcome?.desc    || 'Erlaube die Kamera & bewege das Gerät zum Erkennen der Oberfläche.';
      $('#poster').src          = resolveUrl(cfg.ui?.welcome?.poster || 'poster.jpg', cfg);

      // Native button
      const openNative = $('#btn-open-native');
      openNative.hidden = !shouldShowNativeCTA(cfg);
      openNative.onclick = ()=>{ location.href = buildNativeLink(cfg); };

      // In-App Browser Block
      if (isInApp){
        showBlocker('Dieser In-App-Browser blockiert WebXR-AR. Öffne den Link in Google Chrome.');
      }

      // Preflight: support probe
      if (!window.isSecureContext){
        showBlocker('Unsichere Umgebung. Bitte über HTTPS öffnen.');
      } else if (!('xr' in navigator)){
        // Falls kein WebXR, Native-CTA anbieten
        openNative.hidden = false;
      } else {
        try{
          const ok = await navigator.xr.isSessionSupported('immersive-ar');
          if (!ok) openNative.hidden = false;
        }catch{}
      }

      // Load assets
      await loadModel(cfg);
      $('#status').textContent = 'Bereit – tippe OK';

      // Start button logic
      $('#btn-start').onclick = async ()=>{
        try{
          await startXR(cfg);
          // Karte bleibt sichtbar, bis Hit-Test + Model ready -> hidePreflight()
        }catch(e){
          console.error(e);
          const msg = humanizeXRError(e);
          toast(msg);
          // Wenn echte WebXR-Fehler: Native anbieten + ggf. Blocker bei In-App
          openNative.hidden = false;
          if (isInApp) showBlocker(msg, 'Hinweis: In-App-Browser erkannt.');
        }
      };

      // Wenn WebXR komplett fehlt, Fallback zeigen
      if (!navigator.xr){ openNative.hidden = false; }
    })().catch(err=>{ console.error(err); toast('Fehler: '+(err?.message||err)); });
  </script>
</body>
</html>
