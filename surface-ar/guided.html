<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ARea ‚Äì Surface (Guided)</title>
<link rel="icon" href="data:,">
<style>
  :root{ --bg:#0e1116; --panel:#111828; --panel2:#192339; --text:#e9ecf5; --muted:#9fb3d9; --border:#24314a; }
  html,body{height:100%;margin:0;background:#000;color:var(--text);font:16px/1.4 system-ui,Segoe UI,Inter,Roboto,Arial}
  #app{position:fixed;inset:0}
  canvas{display:block;width:100%;height:100%}

  /* Kamera-Preview hinter dem Welcome (best effort) */
  #camPreview{position:fixed;inset:0;object-fit:cover;z-index:0;display:none}

  /* ========= Welcome als Kachel/Card (statt Fullscreen) ========= */
  .overlay{
    position:fixed; inset:0; display:grid; place-items:center;
    padding:16px; z-index:4;
    background: color-mix(in srgb, var(--bg) 60%, transparent);
    backdrop-filter: blur(4px);
  }
  .card{
    width:min(88vw, 420px);
    border:1px solid var(--border);
    border-radius:18px;
    background:var(--panel);
    box-shadow:0 14px 40px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.04);
    overflow:hidden;
    display:grid; grid-template-rows: auto 1fr;
  }
  .poster{min-height:0}
  .poster img{
    width:100%;
    aspect-ratio:16/9;       /* Kachel, nicht Vollbild */
    object-fit:cover; display:block; background:#0a0f1e;
  }
  .body{
    padding:14px 16px calc(16px + env(safe-area-inset-bottom));
  }
  .eyebrow{font-size:12px;letter-spacing:.18em;text-transform:uppercase;color:var(--muted)}
  h1{font-size:18px;margin:.35rem 0 .4rem;line-height:1.25}
  p{color:#cbd5e1;margin:.2rem 0 .8rem}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:.6rem}
  .btn{
    cursor:pointer;border:1px solid var(--border);
    background:linear-gradient(180deg,#1a2337,#162033);
    color:var(--text);padding:8px 12px;border-radius:10px;font-weight:800
  }
  @media (min-width:900px) and (min-height:540px){
    .card{ width:min(880px,92vw); grid-template-columns:320px 1fr; grid-template-rows:auto }
    .poster img{ height:100%; aspect-ratio:auto }
  }

  /* HUD (in guided nicht genutzt, kann bleiben) */
  .hud{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;display:flex;gap:10px;
       background:rgba(14,17,22,.6);border:1px solid var(--border);border-radius:999px;padding:8px;
       backdrop-filter: blur(6px);z-index:3}
  .hud button{all:unset;cursor:pointer;padding:8px 12px;border-radius:10px}
  .toast{position:fixed;top:12px;right:12px;background:#111828;border:1px solid #24314a;color:#dbe1f1;
         padding:8px 12px;border-radius:10px;font-size:13px;box-shadow:0 8px 24px rgba(0,0,0,.25);z-index:5}

  /* Scan-Loader (in guided nicht genutzt, kann bleiben) */
  .scan-loader{position:fixed;inset:0;display:grid;place-items:center;z-index:5;pointer-events:none;transition:opacity .25s,visibility .25s}
  .scan-loader.hidden{opacity:0;visibility:hidden}
  #wifi-loader{
    --front-color:#7dd3fc;--back-color:color-mix(in srgb,#7dd3fc 25%,transparent);--text-color:#9fb3d9;
    width:64px;height:64px;border-radius:50px;position:relative;display:flex;justify-content:center;align-items:center
  }
  #wifi-loader svg{position:absolute}
  #wifi-loader svg circle{fill:none;stroke-width:6px;stroke-linecap:round;stroke-linejoin:round;transform:rotate(-100deg);transform-origin:center}
  #wifi-loader svg circle.back{stroke:var(--back-color)}
  #wifi-loader svg circle.front{stroke:var(--front-color)}
  #wifi-loader svg.circle-outer{height:86px;width:86px}
  #wifi-loader svg.circle-outer circle{stroke-dasharray:62.75 188.25}
  #wifi-loader svg.circle-outer circle.back{animation:co 1.8s ease infinite .3s}
  #wifi-loader svg.circle-outer circle.front{animation:co 1.8s ease infinite .15s}
  #wifi-loader svg.circle-middle{height:60px;width:60px}
  #wifi-loader svg.circle-middle circle{stroke-dasharray:42.5 127.5}
  #wifi-loader svg.circle-middle circle.back{animation:cm 1.8s ease infinite .25s}
  #wifi-loader svg.circle-middle circle.front{animation:cm 1.8s ease infinite .1s}
  #wifi-loader svg.circle-inner{height:34px;width:34px}
  #wifi-loader svg.circle-inner circle{stroke-dasharray:22 66}
  #wifi-loader svg.circle-inner circle.back{animation:ci 1.8s ease infinite .2s}
  #wifi-loader svg.circle-inner circle.front{animation:ci 1.8s ease infinite .05s}
  #wifi-loader .text{position:absolute;bottom:-40px;font-weight:600;font-size:14px;letter-spacing:.2px;color:var(--text-color)}
  @keyframes co{0%{stroke-dashoffset:25}25%{stroke-dashoffset:0}65%{stroke-dashoffset:301}80%{stroke-dashoffset:276}100%{stroke-dashoffset:276}}
  @keyframes cm{0%{stroke-dashoffset:17}25%{stroke-dashoffset:0}65%{stroke-dashoffset:204}80%{stroke-dashoffset:187}100%{stroke-dashoffset:187}}
  @keyframes ci{0%{stroke-dashoffset:9}25%{stroke-dashoffset:0}65%{stroke-dashoffset:106}80%{stroke-dashoffset:97}100%{stroke-dashoffset:97}}
</style>
</head>
<body>
<video id="camPreview" autoplay muted playsinline></video>
<div id="app"></div>

<!-- Welcome -->
<div id="welcome" class="overlay">
  <div class="card">
    <div class="poster"><img id="welcomePoster" alt="Poster"></div>
    <div class="body">
      <div class="eyebrow" id="welcomeEyebrow">ARea ‚Äì Szene</div>
      <h1 id="welcomeTitle">Willkommen</h1>
      <p id="welcomeDesc">Tippe auf OK, um die Umgebung zu scannen und das Objekt zu platzieren.</p>
      <div class="row">
        <button id="welcomeStart" class="btn" onclick="window.__start && window.__start()">OK</button>
        <span class="muted" id="welcomeHint" style="color:#9fb3d9;font-size:13px">Evtl. erfordert Kamera/Audio einen Tipp</span>
      </div>
    </div>
  </div>
</div>

<!-- Scan-Loader (hier ungenutzt) -->
<div id="scanLoader" class="scan-loader hidden" aria-live="polite">
  <div id="wifi-loader">
    <svg class="circle-outer" viewBox="0 0 86 86">
      <circle class="back" cx="43" cy="43" r="40"></circle>
      <circle class="front" cx="43" cy="43" r="40"></circle>
    </svg>
    <svg class="circle-middle" viewBox="0 0 60 60">
      <circle class="back" cx="30" cy="30" r="27"></circle>
      <circle class="front" cx="30" cy="30" r="27"></circle>
    </svg>
    <svg class="circle-inner" viewBox="0 0 34 34">
      <circle class="back" cx="17" cy="17" r="14"></circle>
      <circle class="front" cx="17" cy="17" r="14"></circle>
    </svg>
    <div class="text">Scanne Umgebung‚Ä¶</div>
  </div>
</div>

<!-- HUD (hier ungenutzt) -->
<div id="hud" class="hud" style="display:none">
  <button id="btnPlay" title="Play/Pause">‚ñ∂Ô∏é/‚è∏</button>
  <button id="btnReplay" title="Neu starten">‚Üª</button>
  <button id="btnSound" title="Ton an/aus">üîä</button>
</div>

<div id="toasts" style="display:grid;gap:10px;position:fixed;top:12px;right:12px"></div>

<!-- Drop-in Script: liest ?scene/?base oder ?src, zeigt Welcome & leitet zu /surface-ar/webxr.html weiter -->
<script type="module">
const $ = s => document.querySelector(s);

// UI-Elemente
const welcome = $('#welcome'),
      poster  = $('#welcomePoster'),
      wTitle  = $('#welcomeTitle'),
      wDesc   = $('#welcomeDesc'),
      wStart  = $('#welcomeStart'),
      wEyebrow= $('#welcomeEyebrow');
const camPreview = $('#camPreview');

const qs   = new URLSearchParams(location.search);
const src  = qs.get('src')   || '';                      // data:-URL oder externes JSON
const scene= qs.get('scene') || '';                      // ver√∂ffentlichte Szene (ID)
const base = qs.get('base')  || location.origin;         // Worker-Base
const anchor = qs.get('anchor') || 'surface-webxr';      // nur weitergereicht

function toastOnce(msg){
  let el = document.getElementById('t1');
  if(!el){
    el = document.createElement('div');
    el.id='t1';
    el.className='toast';
    document.getElementById('toasts')?.appendChild(el) || document.body.appendChild(el);
  }
  el.textContent = msg;
  setTimeout(()=>{ try{ el.remove(); }catch{} }, 2400);
}

async function fetchJSON(url){
  const res = await fetch(url, { cache:'no-store' });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json();
}

async function primeCameraPreview(){
  // optionaler ‚ÄûLive‚Äú-Hintergrund hinter der Card
  try{
    if (!navigator.mediaDevices?.getUserMedia) return;
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal:'environment' } },
      audio: false
    });
    camPreview.srcObject = stream;
    camPreview.style.display = '';
  }catch{
    // wenn geblockt ‚Üí egal
  }
}

function stopCameraPreview(){
  try{
    const s = camPreview?.srcObject;
    if (s) s.getTracks().forEach(t=>t.stop());
  }catch{}
  if (camPreview){
    camPreview.srcObject = null;
    camPreview.style.display = 'none';
  }
}

async function loadWelcome(){
  // Fall A: src (Projekt-Preview)
  if (src){
    try{
      const proj = await fetchJSON(src);
      const sv = proj?.settings?.sceneViewer || {};
      const eyebrow = sv.eyebrow || 'ARea ‚Äì Szene';
      const title   = sv.title   || 'Willkommen';
      const desc    = sv.desc    || 'Tippe auf OK, um zu starten.';
      if (wEyebrow) wEyebrow.textContent = eyebrow;
      if (wTitle)   wTitle.textContent   = title;
      if (wDesc)    wDesc.textContent    = desc;
      if (sv.posterData && poster){
        poster.src = sv.posterData;
      } else if (poster){
        poster.removeAttribute('src');
      }
      return;
    } catch(e){
      toastOnce('Konnte Projekt-Preview nicht lesen.');
    }
  }

  // Fall B: ver√∂ffentlichte Szene (Worker)
  if (scene){
    try{
      const baseClean = base.replace(/\/$/,'');
      const sceneUrl = `${baseClean}/scenes/${encodeURIComponent(scene)}/scene.json`;
      const data = await fetchJSON(sceneUrl);
      const ui = data?.ui?.welcome || {};
      if (wEyebrow) wEyebrow.textContent = ui.eyebrow || 'ARea ‚Äì Szene';
      if (wTitle)   wTitle.textContent   = ui.title   || 'Willkommen';
      if (wDesc)    wDesc.textContent    = ui.desc    || 'Tippe auf OK, um die Umgebung zu scannen und das Objekt zu platzieren.';
      if (poster)   poster.src = `${baseClean}/scenes/${encodeURIComponent(scene)}/poster.jpg`;
      return;
    } catch(e){
      toastOnce('Konnte scene.json nicht laden.');
    }
  }

  // Fallback
  if (wEyebrow) wEyebrow.textContent = 'ARea ‚Äì Szene';
  if (wTitle)   wTitle.textContent   = 'Willkommen';
  if (wDesc)    wDesc.textContent    = 'Tippe auf OK, um zu starten.';
  if (poster)   poster.removeAttribute('src');
}

// Start ‚Üí in den WebXR-Viewer weiterleiten (dort: Hit-Test + Auto-Place)
window.__start = async () => {
  stopCameraPreview();
  const target = new URL('/surface-ar/webxr.html', location.origin);
  if (src){
    target.searchParams.set('src', src);
    target.searchParams.set('anchor', 'surface-webxr');
  } else if (scene){
    target.searchParams.set('scene', scene);
    target.searchParams.set('base',  base);
  }
  if (qs.get('force')) target.searchParams.set('force', qs.get('force'));
  location.replace(target.toString());
};

// Event-Binding
if (wStart) wStart.addEventListener('click', window.__start);

// Init
await loadWelcome();
await primeCameraPreview();
</script>
</body>
</html>
