<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ARea ‚Äì Surface (Guided Native)</title>
<link rel="icon" href="data:,">
<style>
  :root{ --bg:#0e1116; --panel:#111828; --panel2:#192339; --text:#e9ecf5; --muted:#9fb3d9; --border:#24314a; }
  html,body{height:100%;margin:0;background:#000;color:var(--text);font:16px/1.4 system-ui,Segoe UI,Inter,Roboto,Arial}
  #app{position:fixed;inset:0}

  /* ===== Welcome-Card ===== */
  .overlay{
    position:fixed; inset:0; display:grid; place-items:center;
    padding:16px; z-index:4;
    background: color-mix(in srgb, var(--bg) 60%, transparent);
    backdrop-filter: blur(4px);
  }
  .card{
    width:min(88vw, 420px);
    border:1px solid var(--border);
    border-radius:18px;
    background:var(--panel);
    box-shadow:0 14px 40px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.04);
    overflow:hidden;
    display:grid; grid-template-rows: auto 1fr;
  }
  .poster{min-height:0}
  .poster img{
    width:100%;
    aspect-ratio:16/9;
    object-fit:cover; display:block; background:#0a0f1e;
  }
  .body{
    padding:14px 16px calc(16px + env(safe-area-inset-bottom));
  }
  .eyebrow{font-size:12px;letter-spacing:.18em;text-transform:uppercase;color:var(--muted)}
  h1{font-size:18px;margin:.35rem 0 .4rem;line-height:1.25}
  p{color:#cbd5e1;margin:.2rem 0 .8rem}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:.6rem}
  .btn{
    cursor:pointer;border:1px solid var(--border);
    background:linear-gradient(180deg,#1a2337,#162033);
    color:var(--text);padding:8px 12px;border-radius:10px;font-weight:800
  }
  @media (min-width:900px) and (min-height:540px){
    .card{ width:min(880px,92vw); grid-template-columns:320px 1fr; grid-template-rows:auto }
    .poster img{ height:100%; aspect-ratio:auto }
  }

  /* ===== HUD (aktiv in guided native) ===== */
  .hud{
    position:fixed;left:50%;transform:translateX(-50%);
    bottom:16px;display:flex;gap:10px; align-items:center;
    background:rgba(14,17,22,.6);border:1px solid var(--border);border-radius:999px;padding:8px 12px;
    backdrop-filter: blur(6px);z-index:3
  }
  .hud button{all:unset;cursor:pointer;padding:8px 12px;border-radius:10px}
  .hud input[type="range"]{width:120px}
  .toast{position:fixed;top:12px;right:12px;background:#111828;border:1px solid #24314a;color:#dbe1f1;
         padding:8px 12px;border-radius:10px;font-size:13px;box-shadow:0 8px 24px rgba(0,0,0,.25);z-index:5}

  /* Kein Inline-Preview: model-viewer bleibt unsichtbar */
  model-viewer{ position:fixed; inset:0; display:none; }
</style>

<!-- model-viewer (Native AR: Scene Viewer / Quick Look, kein WebXR) -->
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>
<div id="app"></div>

<!-- model-viewer ohne Inline-Preview -->
<model-viewer id="mv"
  ar ar-modes="scene-viewer quick-look"
  reveal="manual"
  camera-controls="false"
  disable-zoom
  shadow-intensity="0"
  style="display:none">
</model-viewer>

<!-- Welcome -->
<div id="welcome" class="overlay" role="dialog" aria-modal="true">
  <div class="card">
    <div class="poster"><img id="welcomePoster" alt="Poster"></div>
    <div class="body">
      <div class="eyebrow" id="welcomeEyebrow">ARea ‚Äì Szene</div>
      <h1 id="welcomeTitle">Willkommen</h1>
      <p id="welcomeDesc">Tippe auf OK, um die AR-Ansicht zu starten.</p>
      <div class="row">
        <button id="welcomeStart" class="btn" onclick="window.__start && window.__start()">OK</button>
        <span class="muted" id="welcomeHint" style="color:#9fb3d9;font-size:13px">Kamera/AR kann einen Tipp erfordern</span>
      </div>
    </div>
  </div>
</div>

<!-- HUD -->
<div id="hud" class="hud">
  <button id="btnPlay" title="Play/Pause">‚ñ∂Ô∏é/‚è∏</button>
  <button id="btnReplay" title="Neu starten">‚Üª</button>
  <button id="btnSound" title="Ton an/aus">üîä</button>
  <input id="vol" type="range" min="0" max="1" step="0.05" value="0.85" title="Lautst√§rke">
</div>

<div id="toasts" style="display:grid;gap:10px;position:fixed;top:12px;right:12px"></div>

<audio id="bgAudio" preload="auto" crossorigin="anonymous"></audio>

<script type="module">
const $ = s => document.querySelector(s);
const toasts= $('#toasts');
const mv    = $('#mv');
const welcome = $('#welcome'),
      poster  = $('#welcomePoster'),
      wTitle  = $('#welcomeTitle'),
      wDesc   = $('#welcomeDesc'),
      wStart  = $('#welcomeStart'),
      wEyebrow= $('#welcomeEyebrow');

const hud = $('#hud'),
      btnPlay  = $('#btnPlay'),
      btnReplay= $('#btnReplay'),
      btnSound = $('#btnSound'),
      vol      = $('#vol');

const audioEl = $('#bgAudio');

const toast = (m)=>{ const d=document.createElement('div'); d.className='toast'; d.textContent=m; toasts.appendChild(d); setTimeout(()=>d.remove(),2600); };
const show  = (el,on)=>{ el && (el.style.display = on ? '' : 'none'); };

const qs = new URLSearchParams(location.search);
const workerBase = (qs.get('base') || 'https://area-publish.area-webar.workers.dev').replace(/\/$/,'');
const sceneId    = (qs.get('scene') || qs.get('id') || '').trim();
const src        = (qs.get('src')   || '').trim();
const configURL  = src || (sceneId ? `${workerBase}/scenes/${encodeURIComponent(sceneId)}/scene.json` : '');
if (!configURL) toast('Keine scene.json ‚Äì ?scene=ID oder ?src=URL verwenden.');

function deepMerge(a,b){ for(const k in b){ if(b[k] && typeof b[k]==='object' && !Array.isArray(b[k])) a[k]=deepMerge(a[k]||{},b[k]); else a[k]=b[k]; } return a; }
const DEFAULTS = {
  ui:{ welcome:{ eyebrow:'ARea ‚Äì Szene', title:'Willkommen', desc:'Tippe auf OK, um zu starten.', cta:'OK', poster:'' }, controls:{ showPlay:true, showMute:true } },
  model:{ url:'', usdz:'', scale:1, rotateY:0, clipName:'*' },
  animation:{ enabled:true, clipName:'*', start:'onStart', loop:true, crossfade:.2 },
  audio:{ url:'', autoplay:'withAnimation', loop:true, volume:.85 }
};
const resolveRel = (u, base)=> !u ? u : (()=>{ try{ return new URL(u,base).href }catch{ return u } })();
async function existsHEAD(url){ try{ const r=await fetch(url,{method:'HEAD',mode:'cors'}); return r.ok }catch{ return false } }

let cfg=structuredClone(DEFAULTS);
let baseVolume = 0.85;
let playing=false;
let hasAnim=false;

(async()=>{
  try{
    const r = await fetch(configURL, { mode:'cors', cache:'no-cache' });
    const j = await r.json();
    cfg = deepMerge(structuredClone(DEFAULTS), j);

    // Resolve URLs
    if (cfg.model?.url)  cfg.model.url  = resolveRel(cfg.model.url,  configURL);
    if (!cfg.model?.usdz && j?.model?.usdz) cfg.model.usdz = resolveRel(j.model.usdz, configURL);

    // Try worker usdz by convention /scenes/:id/scene.usdz
    if (!cfg.model.usdz && sceneId){
      const guess = `${workerBase}/scenes/${encodeURIComponent(sceneId)}/scene.usdz`;
      if (await existsHEAD(guess)) cfg.model.usdz = guess;
    }

    if (!cfg.audio?.url && j?.audio?.src) cfg.audio.url = resolveRel(j.audio.src, configURL);
    if (cfg.audio?.url) cfg.audio.url = resolveRel(cfg.audio.url, configURL);

    // Poster
    let posterUrl = cfg.ui?.welcome?.poster || j?.target?.previewUrl || j?.poster;
    posterUrl = posterUrl ? resolveRel(posterUrl, configURL)
                          : (sceneId ? `${workerBase}/scenes/${encodeURIComponent(sceneId)}/poster.jpg` : null);

    document.title = (cfg.ui?.welcome?.title || 'ARea ‚Äì Surface (Guided Native)');
    wEyebrow.textContent = cfg.ui?.welcome?.eyebrow ?? 'ARea ‚Äì Szene';
    wTitle.textContent   = cfg.ui?.welcome?.title   ?? 'Willkommen';
    wDesc.textContent    = cfg.ui?.welcome?.desc    ?? 'Tippe auf OK, um die AR-Ansicht zu starten.';
    wStart.textContent   = (cfg.ui?.welcome?.cta || 'OK');
    if (posterUrl){ poster.src = posterUrl; } else { document.querySelector('.poster').style.display='none'; }

    // model-viewer setup (hidden)
    if (cfg.model.url)   mv.setAttribute('src', cfg.model.url);
    if (cfg.model.usdz)  mv.setAttribute('ios-src', cfg.model.usdz);

    // Animation
    hasAnim = !!(cfg.animation?.enabled);
    if (cfg.animation?.clipName && cfg.animation.clipName !== '*'){
      mv.setAttribute('animation-name', cfg.animation.clipName);
    } else {
      mv.removeAttribute('animation-name');
    }
    if (cfg.animation?.start === 'onStart'){ mv.setAttribute('autoplay',''); } else { mv.removeAttribute('autoplay'); }
    // Loop-Hinweis: model-viewer animiert standardm√§√üig loopend; explizite Steuerung erfolgt √ºber play().

    // Audio
    baseVolume = cfg.audio?.volume ?? 0.85;
    audioEl.volume = baseVolume;
    if (cfg.audio?.url){ audioEl.src = cfg.audio.url; } else { show(btnSound,false); show(vol,false); }

    // HUD: immer sichtbar wie besprochen
    show(hud,true);

  }catch(e){
    toast('Config konnte nicht geladen ‚Äì nutze Defaults.');
  }
})();

/* === Controls === */
function updateSoundIcon(){
  btnSound.textContent = (audioEl.muted || audioEl.volume === 0) ? 'üîà' : 'üîä';
}
btnPlay.addEventListener('click', ()=>{
  if (playing){ mv.pause(); playing=false; if (cfg.audio?.autoplay === 'withAnimation') audioEl.pause(); }
  else { mv.play();  playing=true;  if (cfg.audio?.autoplay === 'withAnimation') { try{ audioEl.play(); }catch{} } }
});
btnReplay.addEventListener('click', ()=>{
  try{ mv.currentTime = 0; }catch{}
  mv.play(); playing=true;
  if (cfg.audio?.autoplay === 'withAnimation'){ try{ audioEl.currentTime = 0; audioEl.play(); }catch{} }
});
btnSound.addEventListener('click', ()=>{
  audioEl.muted = !audioEl.muted;
  updateSoundIcon();
});
vol.addEventListener('input', ()=>{
  const v = parseFloat(vol.value||'0');
  audioEl.volume = v;
  if (v === 0){ audioEl.muted = true; } else { audioEl.muted = false; }
  updateSoundIcon();
});

/* === Start: Direkt Native-AR === */
function isIOS(){
  const ua = navigator.userAgent || '';
  return /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
}
window.__start = async function(){
  // Startwerte Audio
  updateSoundIcon();
  if (cfg.audio?.url){
    if (cfg.audio?.autoplay === 'onStart' || cfg.audio?.autoplay === 'auto'){ try{ await audioEl.play(); }catch{} }
    else if (cfg.audio?.autoplay === 'withAnimation'){
      // spielt erst bei Play
    }
  }

  // Close welcome
  show(welcome,false);

  // Falls iOS ohne usdz ‚Üí kein Quick Look m√∂glich
  if (isIOS() && !mv.getAttribute('ios-src')){
    toast('iOS Quick Look ben√∂tigt .usdz ‚Äì bitte beim Publish mitliefern.');
    // Fallback: Hier NICHT WebXR starten, wie besprochen. Nur Hinweis.
    return;
  }

  // Direkt native AR starten (Scene Viewer / Quick Look); kein WebXR
  try{
    const ok = await mv.enterAR();
    if (!ok){ toast('AR nicht verf√ºgbar.'); }
  }catch(e){
    toast('AR konnte nicht gestartet werden.');
  }
};

// Nach R√ºckkehr aus AR Animation stoppen (optional)
mv.addEventListener('ar-status', (e)=>{
  if (e.detail.status === 'not-presenting'){
    // Stoppe Audio bei R√ºckkehr, wenn es nur mit Animation laufen soll
    if (cfg.audio?.autoplay === 'withAnimation'){ audioEl.pause(); }
  }
});
</script>
</body>
</html>
